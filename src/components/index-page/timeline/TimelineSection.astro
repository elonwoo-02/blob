---
import type { TimelineEntry } from "../../../data/development.ts";

interface TimelineSectionProps {
  entries: TimelineEntry[];
  title?: string;
  subtitle?: string;
  tagLabel?: string;
}

const {
  entries,
  title = "Development Timeline",
  subtitle = "记录该模块的开发里程碑。",
  tagLabel = "console log",
} = Astro.props as TimelineSectionProps;

const displayEntries = entries;
---

<section class="rounded-3xl p-6">
  <div class="mb-6 flex flex-wrap items-center gap-4">
    <div>
      <h3 class="text-2xl font-semibold">{title}</h3>
      <p class="text-sm">{subtitle}</p>
    </div>
    <span class="ml-auto rounded-full border border-base-300 bg-[var(--app-accent-soft)] px-3 py-1 text-xs text-[var(--app-accent)]">
      {tagLabel}
    </span>
  </div>

  <div>
    {displayEntries.map((entry, index) => {
      const isLast = index === displayEntries.length - 1;
      const padding = index === 0 ? "pt-0" : "pt-6";
      return (
        <article class={`reveal-entry ${padding} translate-y-8 opacity-0 transition-all duration-1000 ease-out`}>
          <div class="flex gap-4">
            <div class="flex flex-col items-center">
              <span class="h-2 w-2 rounded-full bg-[var(--app-accent)] shadow-[0_0_8px_var(--app-focus)]"></span>
              {!isLast && <span class="mt-2 h-full w-px bg-base-300"></span>}
            </div>

            <div class="flex-1 space-y-2 border-l border-base-300 pl-4">
              <div class="flex flex-wrap items-center justify-between gap-2 text-xs uppercase tracking-[0.3em] text-[var(--app-accent)]">
                <span>{entry.date}</span>
                <span class="rounded-full border border-base-300 bg-[var(--app-accent-soft)] px-3 py-1 text-[10px]">{entry.tag}</span>
              </div>
              <h4 class="text-lg font-semibold">{entry.title}</h4>
              <p class="text-sm">{entry.summary}</p>
              <ul class="space-y-1 text-sm">
                {entry.details.map((detail) => (
                  <li class="flex items-start gap-2">
                    <span class="mt-1 h-1.5 w-1.5 rounded-full bg-[var(--app-accent)]"></span>
                    <span>{detail}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </article>
      );
    })}
  </div>
</section>

<script>
  function initRevealObserver() {
    const observerOptions = {
      root: null,
      rootMargin: "0px",
      threshold: 0.15,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.remove("opacity-0", "translate-y-8");
          entry.target.classList.add("opacity-100", "translate-y-0");
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    const targets = document.querySelectorAll(".reveal-entry");
    targets.forEach((target) => observer.observe(target));
  }

  document.addEventListener("astro:page-load", initRevealObserver);

  if (document.readyState === "complete") {
    initRevealObserver();
  } else {
    window.addEventListener("load", initRevealObserver);
  }
</script>
