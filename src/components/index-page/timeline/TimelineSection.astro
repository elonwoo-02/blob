---
import type { TimelineEntry } from '../../../data/development.ts';

// TimelineSectionProps 封装了组件的输入参数：条目数组、标题、副标题、右侧标签
interface TimelineSectionProps {
  entries: TimelineEntry[];
  title?: string;
  subtitle?: string;
  tagLabel?: string;
}

const {
  entries,
  title = 'Development Timeline',
  subtitle = '记录本区域的开发历程。',
  tagLabel = 'console log',
} = Astro.props as TimelineSectionProps;

// 当前组件直接呈现传入条目数组（每个页面传递独立数据）
const displayEntries = entries;
---

<section class="rounded-3xl p-6 ">
  <!-- 标题行：包含时间轴名称、副标题以及右侧标签 -->
  <div class="mb-6 flex flex-wrap items-center gap-4">
    <div>
      <!--<p class="text-xs font-mono uppercase tracking-[0.4em] text-emerald-400">dev log</p>-->
      <h3 class="text-2xl font-semibold">{title}</h3>
      <p class="text-sm">{subtitle}</p>
    </div>
    <span class="ml-auto rounded-full px-3 py-1 text-xs border border-[#2E9CCA]/40 shadow-[inset_0_0_20px_rgba(46,156,202,0.15)]">{tagLabel}</span>
  </div>
  <!-- 时间轴主体：各条目之间暂时无分割 -->
  <div class="">
    {displayEntries.map((entry, index) => {
      const isLast = index === displayEntries.length - 1;
      const padding = index === 0 ? 'pt-0' : 'pt-6';
      return (
        <!-- 每个 article 代表一条开发事件 -->
        <article class={`reveal-entry ${padding} opacity-0 translate-y-8 transition-all duration-1000 ease-out`}>
          <div class="flex gap-4">
            <!-- 时间轴图标列：点 + 竖线 -->
            <div class="flex flex-col items-center">
              <span class="h-2 w-2 rounded-full bg-[#2E9CCA] shadow-[0_0_8px_rgba(46,156,202,0.6)]"></span>
              {!isLast && <span class="mt-2 h-full w-px bg-[#2E9CCA]/40"></span>}
            </div>
            <!-- 内容列：日期、标签、标题、摘要、细节 -->
            <div class="flex-1 space-y-2 border-l border-[#2E9CCA]/10 pl-4">
              <div class="flex flex-wrap items-center justify-between gap-2 text-xs uppercase tracking-[0.3em] text-[#2E9CCA]">
                <span>{entry.date}</span>
                <span class="rounded-full border border-[#2E9CCA]/40 px-3 py-1 text-[10px]">{entry.tag}</span>
              </div>
              <h4 class="text-lg font-semibold">{entry.title}</h4>
              <p class="text-sm">{entry.summary}</p>
              <!-- 细节清单 -->
              <ul class="space-y-1 text-sm">
                {entry.details.map((detail) => (
                  <li class="flex items-start gap-2">
                    <span class="mt-1 h-1.5 w-1.5 rounded-full bg-[#2E9CCA]"></span>
                    <span>{detail}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </article>
      );
    })}
  </div>
</section>

<script>
  /**
   * 使用 Intersection Observer 实现滚动揭示效果
   */
  function initRevealObserver() {
    const observerOptions = {
      root: null,
      rootMargin: '0px',
      threshold: 0.15 // 当 15% 的元素进入视口时触发
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // 添加激活类并移除初始偏移
          entry.target.classList.remove('opacity-0', 'translate-y-8');
          entry.target.classList.add('opacity-100', 'translate-y-0');
          // 一旦显示就不再观察，除非需要重复动画
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    const targets = document.querySelectorAll('.reveal-entry');
    targets.forEach((target) => observer.observe(target));
  }

  // 支持 Astro 的视图转换 (View Transitions)
  document.addEventListener('astro:page-load', initRevealObserver);
  
  // 初始加载处理 (如果当前页面没有 View Transitions 或者是在非 View Transitions 页面)
  if (document.readyState === 'complete') {
    initRevealObserver();
  } else {
    window.addEventListener('load', initRevealObserver);
  }
</script>
