---
const {
  panelId = "terminal-panel",
  outputId = "terminal-output",
  inputId = "terminal-input",
  titleId = "terminal-title",
  title = "terminal://command",
} = Astro.props;
---

<div id="shortcut-overlay" class="shortcut-overlay hidden" aria-hidden="true">
  <div class="shortcut-modal" role="dialog" aria-modal="true">
    <div id={panelId} class="shortcut-panel" aria-labelledby={titleId}>
      <div class="shortcut-titlebar">
        <div class="shortcut-traffic-lights">
          <button type="button" class="shortcut-control shortcut-control-close" data-shortcut-close aria-label="Close"></button>
          <span class="shortcut-control shortcut-control-minimize" aria-hidden="true"></span>
          <span class="shortcut-control shortcut-control-fullscreen" aria-hidden="true"></span>
        </div>
        <h2 id={titleId} class="shortcut-title">{title}</h2>
      </div>
      <div class="shortcut-body">
        <ul id={outputId} class="terminal-output" aria-live="polite"></ul>
        <div class="terminal-input-row terminal-input-row-bottom">
          <span class="terminal-prompt-text">terminal@elblog:~$ </span>
          <input id={inputId} type="text" autocomplete="off" spellcheck="false" />
        </div>
        <div class="terminal-resize-handles" aria-hidden="true">
          <span class="terminal-resize-handle" data-resize="n"></span>
          <span class="terminal-resize-handle" data-resize="s"></span>
          <span class="terminal-resize-handle" data-resize="e"></span>
          <span class="terminal-resize-handle" data-resize="w"></span>
          <span class="terminal-resize-handle" data-resize="ne"></span>
          <span class="terminal-resize-handle" data-resize="nw"></span>
          <span class="terminal-resize-handle" data-resize="se"></span>
          <span class="terminal-resize-handle" data-resize="sw"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<style is:global>
  .shortcut-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(5, 8, 12, 0.55);
    backdrop-filter: blur(6px);
    z-index: 80;
  }

  .shortcut-overlay.hidden {
    display: none;
  }

  .shortcut-modal {
    width: min(760px, 94vw);
    height: min(78vh, 720px);
    min-width: 420px;
    min-height: 360px;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.5);
    background: #1e1e1e;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08), 0 18px 50px rgba(0, 0, 0, 0.55);
    overflow: hidden;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
  }

  .shortcut-panel {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .shortcut-panel.hidden {
    display: none;
  }

  .shortcut-titlebar {
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 0 12px;
    background: linear-gradient(180deg, #2a2a2a, #1b1b1b);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    cursor: move;
    user-select: none;
  }

  .shortcut-titlebar::after {
    content: attr(data-clock);
    position: absolute;
    right: 14px;
    font-size: 12px;
    color: rgba(216, 216, 216, 0.7);
    font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    letter-spacing: 0.08em;
  }

  .shortcut-traffic-lights {
    position: absolute;
    left: 12px;
    display: flex;
    gap: 8px;
  }

  .shortcut-control {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    border: 1px solid rgba(0, 0, 0, 0.35);
    display: inline-block;
    padding: 0;
    background: rgba(255, 255, 255, 0.18);
  }

  .shortcut-control-close {
    background: #ff5f57;
  }

  .shortcut-control-minimize {
    background: #febc2e;
  }

  .shortcut-control-fullscreen {
    background: #28c840;
  }

  .shortcut-title {
    margin: 0;
    font-size: 13px;
    color: #d8d8d8;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .shortcut-body {
    padding: 16px 18px 22px;
    background: #1e1e1e;
    color: #d8d8d8;
    font-family: "SF Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    min-height: 260px;
    display: flex;
    flex: 1;
    flex-direction: column;
    gap: 12px;
  }

  .shortcut-body::after {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    mix-blend-mode: soft-light;
    opacity: 0.2;
  }
  .terminal-output {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 6px;
    overflow: auto;
    max-height: 280px;
    line-height: 18px;
    font-size: 13px;
    flex: 1;
  }

  .terminal-output li {
    font-size: inherit;
    color: rgba(216, 216, 216, 0.9);
    white-space: pre-wrap;
    line-height: 18px;
  }

  .terminal-output li.command {
    color: #a8d8ff;
  }

  .terminal-output li.error {
    color: #ff8c8c;
  }

  .terminal-output li.dim {
    color: rgba(216, 216, 216, 0.6);
  }

  .terminal-input-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 2px 2px;
    background: transparent;
  }

  .terminal-input-row-bottom {
    margin-top: auto;
  }

  .terminal-prompt-text {
    color: #a8d8ff;
    font-size: 13px;
    line-height: 18px;
  }

  @keyframes terminal-typing {
    from { width: 0; }
    to { width: 8ch; }
  }

  @keyframes terminal-blink {
    0%, 45% { opacity: 1; }
    46%, 100% { opacity: 0; }
  }

  #terminal-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #d8d8d8;
    font-size: 13px;
    caret-color: #a8d8ff;
    line-height: 18px;
  }

  .terminal-resize-handles {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .terminal-resize-handle {
    position: absolute;
    pointer-events: auto;
  }

  .terminal-resize-handle[data-resize='n'],
  .terminal-resize-handle[data-resize='s'] {
    left: 10px;
    right: 10px;
    height: 10px;
  }

  .terminal-resize-handle[data-resize='n'] {
    top: -4px;
    cursor: ns-resize;
  }

  .terminal-resize-handle[data-resize='s'] {
    bottom: -4px;
    cursor: ns-resize;
  }

  .terminal-resize-handle[data-resize='e'],
  .terminal-resize-handle[data-resize='w'] {
    top: 10px;
    bottom: 10px;
    width: 10px;
  }

  .terminal-resize-handle[data-resize='e'] {
    right: -4px;
    cursor: ew-resize;
  }

  .terminal-resize-handle[data-resize='w'] {
    left: -4px;
    cursor: ew-resize;
  }

  .terminal-resize-handle[data-resize='ne'],
  .terminal-resize-handle[data-resize='nw'],
  .terminal-resize-handle[data-resize='se'],
  .terminal-resize-handle[data-resize='sw'] {
    width: 14px;
    height: 14px;
  }

  .terminal-resize-handle[data-resize='ne'] {
    top: -6px;
    right: -6px;
    cursor: nesw-resize;
  }

  .terminal-resize-handle[data-resize='nw'] {
    top: -6px;
    left: -6px;
    cursor: nwse-resize;
  }

  .terminal-resize-handle[data-resize='se'] {
    bottom: -6px;
    right: -6px;
    cursor: nwse-resize;
  }

  .terminal-resize-handle[data-resize='sw'] {
    bottom: -6px;
    left: -6px;
    cursor: nesw-resize;
  }

  .terminal-output li.dim button {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    color: inherit;
    font: inherit;
    cursor: pointer;
    text-align: left;
  }

  .terminal-output li.dim button:hover {
    color: #a8d8ff;
    text-decoration: underline;
  }

  .shortcut-list {
    display: none;
  }
</style>

<script>
  const overlay = document.getElementById('shortcut-overlay');
  const terminalPanel = document.getElementById('terminal-panel');
  const terminalModal = document.querySelector('.shortcut-modal');
  const terminalTitlebar = document.querySelector('.shortcut-titlebar');
  const terminalInput = document.getElementById('terminal-input');
  const terminalOutput = document.getElementById('terminal-output');
  const closeButtons = document.querySelectorAll('[data-shortcut-close]');
  const titlebars = document.querySelectorAll('.shortcut-titlebar');
  const dock = document.querySelector('#mac-dock');

  let sequence = '';
  let sequenceTimer = null;

  const isEditableTarget = (target) => {
    if (!target) return false;
    const tag = target.tagName?.toLowerCase?.();
    return target.isContentEditable || ['input', 'textarea', 'select'].includes(tag);
  };

  const updateClock = () => {
    const now = new Date();
    const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    titlebars.forEach((bar) => bar.setAttribute('data-clock', time));
  };

  updateClock();
  window.setInterval(updateClock, 30000);

  const openOverlay = (panel) => {
    overlay?.classList.remove('hidden');
    overlay?.setAttribute('aria-hidden', 'false');
    panel?.classList.remove('hidden');
  };

  const closeOverlay = () => {
    overlay?.classList.add('hidden');
    overlay?.setAttribute('aria-hidden', 'true');
    terminalPanel?.classList.add('hidden');
  };

  const navigateTo = (path) => {
    window.location.assign(path);
  };

  const pushLine = (text, type = 'output') => {
    if (!terminalOutput) return;
    const li = document.createElement('li');
    li.textContent = text;
    li.classList.add(type);
    terminalOutput.append(li);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  };

  const pushClickable = (label, command) => {
    if (!terminalOutput) return;
    const li = document.createElement('li');
    li.classList.add('dim');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = label;
    btn.addEventListener('click', () => {
      terminalInput.value = command;
      terminalInput.focus();
    });
    li.append(btn);
    terminalOutput.append(li);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  };

  const openTerminal = () => {
    openOverlay(terminalPanel);
    if (terminalModal && !terminalModal.dataset.positioned) {
      terminalModal.style.left = '50%';
      terminalModal.style.top = '50%';
      terminalModal.style.transform = 'translate(-50%, -50%)';
      terminalModal.dataset.positioned = 'true';
    }
    if (terminalOutput && terminalOutput.children.length === 0 && history.length) {
      pushLine('Last session:', 'dim');
      history.slice(-5).forEach((entry, index) => {
        const idx = history.length - 5 + index + 1;
        pushClickable(`${idx}. ${entry}`, entry);
      });
    }
    terminalInput?.focus();
  };

  if (terminalTitlebar && terminalModal) {
    let dragStartX = 0;
    let dragStartY = 0;
    let modalStartX = 0;
    let modalStartY = 0;
    let dragging = false;

    const onMouseMove = (event) => {
      if (!dragging) return;
      const dx = event.clientX - dragStartX;
      const dy = event.clientY - dragStartY;
      terminalModal.style.left = `${modalStartX + dx}px`;
      terminalModal.style.top = `${modalStartY + dy}px`;
      terminalModal.style.transform = 'translate(0, 0)';
    };

    const onMouseUp = () => {
      dragging = false;
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('mouseup', onMouseUp);
    };

    terminalTitlebar.addEventListener('mousedown', (event) => {
      if (event.button !== 0) return;
      dragging = true;
      const rect = terminalModal.getBoundingClientRect();
      dragStartX = event.clientX;
      dragStartY = event.clientY;
      modalStartX = rect.left;
      modalStartY = rect.top;
      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);
    });
  }

  if (terminalModal) {
    const handles = terminalModal.querySelectorAll('.terminal-resize-handle');
    const minWidth = 420;
    const minHeight = 320;
    let resizeStartX = 0;
    let resizeStartY = 0;
    let startLeft = 0;
    let startTop = 0;
    let startWidth = 0;
    let startHeight = 0;
    let activeDir = '';

    const applyResize = (moveEvent) => {
      const deltaX = moveEvent.clientX - resizeStartX;
      const deltaY = moveEvent.clientY - resizeStartY;
      let nextWidth = startWidth;
      let nextHeight = startHeight;
      let nextLeft = startLeft;
      let nextTop = startTop;

      if (activeDir.includes('e')) {
        nextWidth = Math.max(minWidth, startWidth + deltaX);
      }
      if (activeDir.includes('s')) {
        nextHeight = Math.max(minHeight, startHeight + deltaY);
      }
      if (activeDir.includes('w')) {
        const next = Math.max(minWidth, startWidth - deltaX);
        nextLeft = startLeft + (startWidth - next);
        nextWidth = next;
      }
      if (activeDir.includes('n')) {
        const next = Math.max(minHeight, startHeight - deltaY);
        nextTop = startTop + (startHeight - next);
        nextHeight = next;
      }

      terminalModal.style.left = `${nextLeft}px`;
      terminalModal.style.top = `${nextTop}px`;
      terminalModal.style.width = `${nextWidth}px`;
      terminalModal.style.height = `${nextHeight}px`;
      terminalModal.style.transform = 'translate(0, 0)';
    };

    const stopResize = () => {
      window.removeEventListener('mousemove', applyResize);
      window.removeEventListener('mouseup', stopResize);
    };

    handles.forEach((handle) => {
      handle.addEventListener('mousedown', (event) => {
        event.preventDefault();
        event.stopPropagation();
        const rect = terminalModal.getBoundingClientRect();
        activeDir = handle.dataset.resize || '';
        resizeStartX = event.clientX;
        resizeStartY = event.clientY;
        startLeft = rect.left;
        startTop = rect.top;
        startWidth = rect.width;
        startHeight = rect.height;
        window.addEventListener('mousemove', applyResize);
        window.addEventListener('mouseup', stopResize);
      });
    });
  }

  const getPreferredTheme = () =>
    window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

  const setThemeMode = (mode) => {
    const resolved = mode === 'auto' ? getPreferredTheme() : mode;
    document.documentElement.setAttribute('data-theme', resolved);
    window.localStorage.setItem('theme', mode);
  };

  const themeMedia = window.matchMedia('(prefers-color-scheme: dark)');
  themeMedia.addEventListener('change', () => {
    if (window.localStorage.getItem('theme') === 'auto') {
      setThemeMode('auto');
    }
  });

  const showHelp = () => {
    pushLine('Commands:');
    pushLine('  help                 Show all commands', 'dim');
    pushLine('  help <cmd>            Show command usage', 'dim');
    pushLine('  home                 Go to Home', 'dim');
    pushLine('  blog                 Go to Blog', 'dim');
    pushLine('  about                Go to About', 'dim');
    pushLine('  bookmarks            Go to Bookmarks', 'dim');
    pushLine('  theme dark|light|auto Switch theme', 'dim');
    pushLine('  theme toggle          Toggle theme', 'dim');
    pushLine('  open <url>            Open a URL', 'dim');
    pushLine('  search <keyword>      Filter posts by keyword', 'dim');
    pushLine('  search tags <tag>     Filter posts by tag', 'dim');
    pushLine('  notes                Show quick notes', 'dim');
    pushLine('  notes add <text>      Add a note', 'dim');
    pushLine('  notes clear           Clear all notes', 'dim');
    pushLine('  draft <title>         New draft template', 'dim');
    pushLine('  post <title>          New post template', 'dim');
    pushLine('  links                Show common links', 'dim');
    pushLine('  export               Download terminal output', 'dim');
    pushLine('  toggle dock          Show/hide dock', 'dim');
    pushLine('  profile              Show profile info', 'dim');
    pushLine('  version              Show app version', 'dim');
    pushLine('  clear                Clear terminal output', 'dim');
    pushLine('  clear-history        Clear all command history', 'dim');
    pushLine('  !<n>                 Re-run history item', 'dim');
    pushLine('  reset-layout         Clear saved window layout', 'dim');
    pushLine('  reload               Reload current page', 'dim');
    pushLine('  status               Show page status', 'dim');
    pushLine('  exit                 Close terminal', 'dim');
  };

  const showHelpFor = (cmd) => {
    switch (cmd) {
      case 'help':
        pushLine('help [command] - show command list or usage', 'dim');
        break;
      // TODO: Add aibot command to route AI assistant interactions via terminal.
      case 'home':
        pushLine('home - go to Home', 'dim');
        break;
      case 'blog':
        pushLine('blog - go to Blog', 'dim');
        break;
      case 'about':
        pushLine('about - go to About', 'dim');
        break;
      case 'bookmarks':
        pushLine('bookmarks - go to Bookmarks', 'dim');
        break;
      case 'theme':
        pushLine('theme dark|light|auto|toggle - switch theme', 'dim');
        break;
      case 'open':
        pushLine('open <url> - open a URL', 'dim');
        break;
      case 'search':
        pushLine('search <keyword> - list matching posts', 'dim');
        pushLine('search tags <tag> - list posts by tag', 'dim');
        break;
      case 'notes':
        pushLine('notes - show quick notes', 'dim');
        pushLine('notes add <text> - add a note', 'dim');
        pushLine('notes clear - clear all notes', 'dim');
        break;
      case 'draft':
        pushLine('draft <title> - output draft template', 'dim');
        break;
      case 'post':
        pushLine('post <title> - output post template', 'dim');
        break;
      case 'links':
        pushLine('links - show common links', 'dim');
        break;
      case 'export':
        pushLine('export - download terminal output', 'dim');
        break;
      case 'toggle':
        pushLine('toggle dock - show/hide dock', 'dim');
        break;
      case 'profile':
        pushLine('profile - show profile info', 'dim');
        break;
      case 'version':
        pushLine('version - show app version', 'dim');
        break;
      case 'clear':
        pushLine('clear - clear terminal output', 'dim');
        break;
      case 'reset-layout':
        pushLine('reset-layout - clear saved window layout', 'dim');
        break;
      case 'reload':
        pushLine('reload - reload current page', 'dim');
        break;
      case 'status':
        pushLine('status - show location, theme, online', 'dim');
        break;
      case 'exit':
        pushLine('exit - close terminal', 'dim');
        break;
      default:
        pushLine(`No help for "${cmd}".`, 'dim');
        break;
    }
  };

  let lastSearchResults = [];

  const runSearch = async (keyword) => {
    if (!keyword) {
      pushLine('Usage: search <keyword>', 'error');
      return;
    }
    pushLine(`Searching for "${keyword}"...`, 'dim');
    try {
      const res = await fetch('/search.json');
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      const needle = keyword.toLowerCase();
      const matches = items.filter((item) => {
        const title = (item.title || '').toLowerCase();
        const description = (item.description || '').toLowerCase();
        const tags = Array.isArray(item.tags) ? item.tags.join(' ').toLowerCase() : '';
        return title.includes(needle) || description.includes(needle) || tags.includes(needle);
      }).slice(0, 6);
      lastSearchResults = matches;
      if (!matches.length) {
        pushLine('No results.', 'dim');
        return;
      }
      matches.forEach((item) => {
        pushLine(`${item.title} -> ${item.url}`);
        if (item.description) {
          pushLine(`  ${item.description}`, 'dim');
        }
        if (Array.isArray(item.tags) && item.tags.length) {
          pushLine(`  #${item.tags.join(' #')}`, 'dim');
        }
      });
    } catch {
      lastSearchResults = [];
      pushLine('Search index not available.', 'error');
    }
  };

  const runTagSearch = async (tag) => {
    if (!tag) {
      pushLine('Usage: search tags <tag>', 'error');
      return;
    }
    pushLine(`Searching tag "${tag}"...`, 'dim');
    try {
      const res = await fetch('/search.json');
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      const needle = tag.toLowerCase();
      const matches = items.filter((item) => {
        const tags = Array.isArray(item.tags) ? item.tags : [];
        return tags.some((t) => t.toLowerCase() === needle);
      }).slice(0, 8);
      lastSearchResults = matches;
      if (!matches.length) {
        pushLine('No results.', 'dim');
        return;
      }
      matches.forEach((item) => {
        pushLine(`${item.title} -> ${item.url}`);
        if (item.description) {
          pushLine(`  ${item.description}`, 'dim');
        }
        if (Array.isArray(item.tags) && item.tags.length) {
          pushLine(`  #${item.tags.join(' #')}`, 'dim');
        }
      });
    } catch {
      lastSearchResults = [];
      pushLine('Search index not available.', 'error');
    }
  };

  const notesKey = 'terminal-notes';
  const readNotes = () => JSON.parse(window.localStorage.getItem(notesKey) || '[]');
  const writeNotes = (notes) => {
    window.localStorage.setItem(notesKey, JSON.stringify(notes.slice(-100)));
  };

  const showNotes = () => {
    const notes = readNotes();
    if (!notes.length) {
      pushLine('No notes yet. Use: notes add <text>', 'dim');
      return;
    }
    pushLine('Notes:', 'dim');
    const startIndex = Math.max(0, notes.length - 10);
    notes.slice(-10).forEach((note, index) => {
      pushLine(`${startIndex + index + 1}. ${note}`, 'dim');
    });
  };

  const generateTemplate = (kind, title) => {
    const date = new Date().toISOString().slice(0, 10);
    const safeTitle = title || 'Untitled';
    const template = [
      '---',
      `title: ${safeTitle}`,
      `date: ${date}`,
      'description: ',
      'tags: []',
      '---',
      '',
      '# ' + safeTitle,
      '',
      kind === 'draft' ? '> Draft notes here.' : 'Write here.',
      '',
    ].join('\n');
    pushLine(template);
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(template).then(
        () => pushLine('Template copied to clipboard.', 'dim'),
        () => pushLine('Copy failed. Select and copy manually.', 'dim'),
      );
    }
  };

  const showLinks = () => {
    pushLine('Links:', 'dim');
    pushLine('Home -> /', 'dim');
    pushLine('Blog -> /blog/', 'dim');
    pushLine('About -> /about/', 'dim');
    pushLine('Tags -> /tags/', 'dim');
    pushLine('RSS -> /rss.xml', 'dim');
  };

  const exportOutput = () => {
    if (!terminalOutput) return;
    const lines = Array.from(terminalOutput.children).map((li) => li.textContent || '');
    if (!lines.length) {
      pushLine('Nothing to export.', 'dim');
      return;
    }
    const stamp = new Date().toISOString().replace(/[:.]/g, '-');
    const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `terminal-log-${stamp}.txt`;
    document.body.append(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
    pushLine('Exported terminal output.', 'dim');
  };

  const toggleDock = () => {
    const root = document.documentElement;
    const isHidden = root.classList.toggle('dock-hidden');
    window.localStorage.setItem('dock-hidden', isHidden ? '1' : '0');
    if (dock) {
      dock.style.opacity = isHidden ? '0' : '';
    }
    pushLine(isHidden ? 'Dock hidden.' : 'Dock shown.', 'dim');
  };

  const showProfile = () => {
    pushLine('Profile:', 'dim');
    pushLine(`title: ${document.title}`, 'dim');
    pushLine(`origin: ${window.location.origin}`, 'dim');
    const theme = window.localStorage.getItem('theme') || 'light';
    pushLine(`theme: ${theme}`, 'dim');
  };

  const showVersion = () => {
    pushLine('App version:', 'dim');
    pushLine(`build: ${document.lastModified}`, 'dim');
    pushLine(`runtime: ${navigator.userAgent}`, 'dim');
  };

  closeButtons.forEach((btn) => {
    btn.addEventListener('click', closeOverlay);
  });

  overlay?.addEventListener('click', (event) => {
    if (event.target === overlay) closeOverlay();
  });

  document.addEventListener('click', (event) => {
    const trigger = event.target?.closest?.('[data-action="terminal"]');
    if (!trigger) return;
    event.preventDefault();
    openTerminal();
  });

  // Bot click does not affect Elon.

  document.addEventListener('keydown', (event) => {
    const key = event.key;
    if (key === 'Escape' && !overlay?.classList.contains('hidden')) {
      event.preventDefault();
      closeOverlay();
      return;
    }

    if (event.metaKey || event.ctrlKey || event.altKey) return;
    if (isEditableTarget(event.target)) return;

    if (key === 'k' || key === 'K') {
      event.preventDefault();
      openTerminal();
      return;
    }

    if (key === 'h' || key === 'H') {
      event.preventDefault();
      navigateTo('/');
      return;
    }

    if (key === 'g' || key === 'G') {
      sequence = 'g';
      window.clearTimeout(sequenceTimer);
      sequenceTimer = window.setTimeout(() => {
        sequence = '';
      }, 800);
      return;
    }

    if (sequence === 'g') {
      if (key === 'b' || key === 'B') {
        event.preventDefault();
        sequence = '';
        navigateTo('/blog/');
        return;
      }
      if (key === 'a' || key === 'A') {
        event.preventDefault();
        sequence = '';
        navigateTo('/about/');
        return;
      }
    }
  });

  const elonBot = document.getElementById('elon-bot');
  if (elonBot && window.self !== window.top) {
    elonBot.classList.add('is-hidden');
    elonBot.setAttribute('aria-hidden', 'true');
  }

  const historyKey = 'terminal-history';
  const history = JSON.parse(window.localStorage.getItem(historyKey) || '[]');
  let historyIndex = -1;
  const commands = [
    'help',
    'home',
    'blog',
    'about',
    'bookmarks',
    'theme',
    'open',
    'search',
    'notes',
    'draft',
    'post',
    'links',
    'export',
    'toggle',
    'profile',
    'version',
    'clear',
    'reset-layout',
    'reload',
    'status',
    'exit',
    'clear-history',
  ];
  const completeInput = () => {
    const raw = terminalInput.value;
    const parts = raw.split(' ');
    if (parts.length === 0) return;
    const head = parts[0];
    if (!head) return;
    const matches = commands.filter((cmd) => cmd.startsWith(head));
    if (matches.length === 1) {
      parts[0] = matches[0];
      terminalInput.value = parts.join(' ');
    } else if (matches.length > 1) {
      pushLine(matches.join(' '), 'dim');
    }
  };

  terminalInput?.addEventListener('keydown', (event) => {
    if (event.key === 'Tab') {
      event.preventDefault();
      completeInput();
      return;
    }
    if (event.key === 'ArrowUp') {
      event.preventDefault();
      if (!history.length) return;
      historyIndex = Math.min(historyIndex + 1, history.length - 1);
      terminalInput.value = history[history.length - 1 - historyIndex];
      return;
    }
    if (event.key === 'ArrowDown') {
      event.preventDefault();
      if (!history.length) return;
      historyIndex = Math.max(historyIndex - 1, -1);
      terminalInput.value = historyIndex === -1 ? '' : history[history.length - 1 - historyIndex];
      return;
    }
    if (event.key !== 'Enter') return;
    const raw = terminalInput.value.trim();
    if (!raw) {
      if (lastSearchResults.length) {
        navigateTo(lastSearchResults[0].url);
      }
      return;
    }
    const executeCommand = (command, argument) => {
      switch (command.toLowerCase()) {
        case 'help':
          if (argument) {
            showHelpFor(argument);
          } else {
            showHelp();
          }
          break;
        case 'home':
          navigateTo('/');
          break;
        case 'blog':
          navigateTo('/blog/');
          break;
        case 'about':
          navigateTo('/about/');
          break;
        case 'bookmarks':
          navigateTo('/bookmarks/');
          break;
        case 'theme':
          if (argument === 'dark' || argument === 'light' || argument === 'auto') {
            setThemeMode(argument);
            pushLine(`Theme set to ${argument}.`, 'dim');
          } else if (argument === 'toggle') {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const next = currentTheme === 'dark' ? 'light' : 'dark';
            setThemeMode(next);
            pushLine(`Theme set to ${next}.`, 'dim');
          } else {
            pushLine('Usage: theme dark|light|auto|toggle', 'error');
          }
          break;
        case 'open':
          if (!argument) {
            pushLine('Usage: open <url>', 'error');
            break;
          }
          navigateTo(argument);
          break;
        case 'search':
          if (argument.startsWith('tags ')) {
            runTagSearch(argument.slice(5).trim());
          } else {
            runSearch(argument);
          }
          break;
        case 'notes': {
          const [sub, ...rest] = argument.split(' ');
          if (sub === 'add') {
            const note = rest.join(' ').trim();
            if (!note) {
              pushLine('Usage: notes add <text>', 'error');
              break;
            }
            const notes = readNotes();
            notes.push(note);
            writeNotes(notes);
            pushLine('Note saved.', 'dim');
            break;
          }
          if (sub === 'clear') {
            writeNotes([]);
            pushLine('Notes cleared.', 'dim');
            break;
          }
          showNotes();
          break;
        }
        case 'draft':
          generateTemplate('draft', argument);
          break;
        case 'post':
          generateTemplate('post', argument);
          break;
        case 'links':
          showLinks();
          break;
        case 'export':
          exportOutput();
          break;
        case 'toggle':
          if (argument === 'dock') {
            toggleDock();
          } else {
            pushLine('Usage: toggle dock', 'error');
          }
          break;
        case 'profile':
          showProfile();
          break;
        case 'version':
          showVersion();
          break;
        case 'clear':
          if (terminalOutput) terminalOutput.innerHTML = '';
          lastSearchResults = [];
          break;
        case 'reload':
          window.location.reload();
          break;
        case 'status': {
          const theme = window.localStorage.getItem('theme') || 'light';
          pushLine(`path: ${window.location.pathname}`, 'dim');
          pushLine(`theme: ${theme}`, 'dim');
          pushLine(`online: ${navigator.onLine ? 'yes' : 'no'}`, 'dim');
          break;
        }
        case 'reset-layout':
          Object.keys(window.localStorage).forEach((key) => {
            if (key.startsWith('dock:panel:')) {
              window.localStorage.removeItem(key);
            }
          });
          pushLine('Layout reset. Reopen panels to re-center.', 'dim');
          break;
        case 'clear-history':
          history.length = 0;
          window.localStorage.removeItem(historyKey);
          pushLine('History cleared.', 'dim');
          break;
        case 'exit':
          closeOverlay();
          break;
        default:
          pushLine(`Unknown command: ${command}`, 'error');
          pushLine('Type "help" to see available commands.', 'dim');
          break;
      }
    };

    if (raw.startsWith('!')) {
      const idx = Number(raw.slice(1));
      if (Number.isInteger(idx) && idx >= 1 && idx <= history.length) {
        const cmdToRun = history[idx - 1];
        terminalInput.value = '';
        pushLine(`$ ${cmdToRun}`, 'command');
        const [cmd, ...rest] = cmdToRun.split(' ');
        const arg = rest.join(' ').trim();
        executeCommand(cmd, arg);
        return;
      } else {
        pushLine('Usage: !<n> (n from 1 to history length)', 'error');
        return;
      }
    }
    history.push(raw);
    window.localStorage.setItem(historyKey, JSON.stringify(history.slice(-100)));
    historyIndex = -1;
    pushLine(`$ ${raw}`, 'command');
    terminalInput.value = '';
    const [cmd, ...rest] = raw.split(' ');
    const arg = rest.join(' ').trim();
    executeCommand(cmd, arg);
  });
</script>
