---
// BlogDrawerSidebar.astro - Sidebar for blog page
import BlogHeatmapSection from "./BlogHeatmapSection.astro";
import NavigationSection from "../navigation/NavigationSection.astro";
import BlogTagSection from "./BlogTagSection.astro";

const { heatmap, tagTree } = Astro.props;
---

<aside
  id="drawer-sidebar"
  class="drawer-sidebar fixed top-0 left-0 h-screen w-80 bg-base-100 z-40 overflow-y-auto"
  style="transition: margin-left 500ms cubic-bezier(0.4, 0, 0.2, 1); margin-left: -320px;"
>
  <div class="drawer-content flex flex-col h-full">
    <!-- Header -->
    <div
      class="drawer-header p-4 flex justify-between items-center text-gray-400"
    >
      <!-- Left: Sidebar Toggle (Close) -->
      <button
        id="drawer-close"
        class="p-2 hover:bg-base-200 hover:text-gray-600 rounded-lg transition-all duration-200"
        aria-label="Close Sidebar"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0l-3.75-3.75M17.25 21L21 17.25"
          ></path>
          <!-- Replaced with a more generic Sidebar/Layout icon since Heroicons doesn't have the exact Flomo one. 
               Using a custom path to mimic the [ | ] look from the image -->
          <path
            d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"
            stroke-width="1.5"></path>
          <path d="M9 4v16" stroke-width="1.5"></path>
        </svg>
      </button>

      <!-- Right: Actions -->
      <div class="flex items-center gap-1">
        <!-- Notification -->
        <button
          class="p-2 hover:bg-base-200 hover:text-gray-600 rounded-lg transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"
            ></path>
          </svg>
        </button>
        <!-- Settings -->
        <button
          class="p-2 hover:bg-base-200 hover:text-gray-600 rounded-lg transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Sections -->
    <div class="drawer-body flex-1 overflow-y-auto">
      <!-- Flomo Profile & Stats -->
      <div class="px-6 pt-2 pb-4">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
            <img
              src="/avatars/default.png"
              alt="User Avatar"
              class="w-full h-full object-cover opacity-80"
            />
          </div>
          <div>
            <div class="text-base font-bold text-base-content/90 leading-tight">
              My Blog
            </div>
            <div class="text-xs text-base-content/40 mt-0.5">
              @dimensional-debris
            </div>
          </div>
          <span
            class="ml-auto px-1.5 py-0.5 bg-yellow-100 text-yellow-700 text-[10px] font-bold uppercase rounded border border-yellow-200/50"
            >PRO</span
          >
        </div>

        <div class="flex justify-between px-2 mb-2">
          <div class="text-center">
            <div class="text-xl font-bold text-base-content/80 leading-none">
              1602
            </div>
            <div
              class="text-[10px] text-base-content/40 font-bold uppercase mt-1"
            >
              MEMO
            </div>
          </div>
          <div class="text-center">
            <div class="text-xl font-bold text-base-content/80 leading-none">
              60
            </div>
            <div
              class="text-[10px] text-base-content/40 font-bold uppercase mt-1"
            >
              TAG
            </div>
          </div>
          <div class="text-center">
            <div class="text-xl font-bold text-base-content/80 leading-none">
              1547
            </div>
            <div
              class="text-[10px] text-base-content/40 font-bold uppercase mt-1"
            >
              DAY
            </div>
          </div>
        </div>
      </div>

      <BlogHeatmapSection heatmap={heatmap} />
      <NavigationSection />
      <BlogTagSection tagTree={tagTree} />
    </div>
  </div>
</aside>

<script>
  const drawer = document.getElementById("drawer-sidebar");
  const closeButton = document.getElementById("drawer-close");

  let isOpen = false;

  function toggleDrawer() {
    isOpen = !isOpen;

    if (isOpen) {
      drawer?.style.setProperty("margin-left", "0");
    } else {
      drawer?.style.setProperty("margin-left", "-320px");
    }

    // Dispatch event to notify content area to adjust
    const event = new CustomEvent("drawer-state-changed", {
      detail: { isOpen },
    });
    window.dispatchEvent(event);
  }

  // Listen for toggle event from DrawerToggle
  window.addEventListener("toggle-drawer", toggleDrawer);

  // Close drawer when clicking close button
  closeButton?.addEventListener("click", toggleDrawer);

  // ============================================
  // 标签树展开/折叠功能
  // ============================================
  document.querySelectorAll(".tag-toggle").forEach((toggleButton) => {
    toggleButton.addEventListener("click", () => {
      const listItem = toggleButton.closest("li");
      const children = listItem?.querySelector(":scope > .tag-children");
      if (!children) return;

      // 切换展开状态
      const expanded = toggleButton.getAttribute("data-expanded") !== "false";
      const nextExpanded = !expanded;
      toggleButton.setAttribute("data-expanded", `${nextExpanded}`);
      toggleButton.setAttribute("aria-expanded", `${nextExpanded}`);
      toggleButton.textContent = nextExpanded ? "▾" : "▸";
      children.classList.toggle("hidden", !nextExpanded);
    });
  });
</script>

<style>
  .drawer-sidebar,
  .drawer-sidebar * {
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
  }

  .drawer-sidebar::-webkit-scrollbar,
  .drawer-sidebar *::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
  }
</style>
