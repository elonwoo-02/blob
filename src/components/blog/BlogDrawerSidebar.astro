---
// BlogDrawerSidebar.astro - Sidebar for blog page
import BlogHeatmapSection from "./BlogHeatmapSection.astro";
import BlogTagSection from "./BlogTagSection.astro";

const { heatmap, tagTree, stats } = Astro.props;
---

<aside
  id="drawer-sidebar"
  class="drawer-sidebar h-screen bg-base-100 flex-shrink-0"
  style="transition: width 500ms cubic-bezier(0.4, 0, 0.2, 1); width: 320px; overflow: hidden;"
>
  <div class="drawer-content flex flex-col h-full overflow-y-auto">
    <!-- Header -->
    <div
      class="drawer-header p-4 flex justify-between items-center text-gray-400"
    >
      <!-- Left: Sidebar Toggle (Close) -->
      <button
        id="drawer-close"
        class="p-2.5 hover:bg-base-200 text-base-content/40 hover:text-base-content/70 rounded-xl transition-all duration-200 group"
        aria-label="Close Sidebar"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-5 h-5 transition-transform duration-300 group-hover:scale-95"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <!-- Sidebar Close Layout Icon -->
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
      </button>

      <!-- Right: Actions -->
      <div class="flex items-center gap-1">
        <!-- Notification -->
        <button
          class="p-2 hover:bg-base-200 hover:text-gray-600 rounded-lg transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"
            ></path>
          </svg>
        </button>
        <!-- Settings -->
        <button
          class="p-2 hover:bg-base-200 hover:text-gray-600 rounded-lg transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Sections -->
    <div class="drawer-body flex-1 overflow-y-auto">
      <!-- Flomo Profile & Stats -->
      <div class="px-6 pt-2 pb-4">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
            <img
              src="/avatars/default.png"
              alt="User Avatar"
              class="w-full h-full object-cover opacity-80"
            />
          </div>
          <div>
            <div class="text-base font-bold text-base-content/90 leading-tight">

            </div>
            <div class="text-xs text-base-content/40 mt-0.5">
              @dimensional-debris
            </div>
          </div>
          <span
            class="ml-auto px-1.5 py-0.5 bg-yellow-100 text-yellow-700 text-[10px] font-bold uppercase rounded border border-yellow-200/50"
            >PRO</span
          >
        </div>

        <div class="flex justify-between px-2 mb-2">
          <div class="text-center">
            <div class="text-xl font-bold text-base-content/80 leading-none">
              {stats.totalPosts}
            </div>
            <div
              class="text-[10px] text-base-content/40 font-bold uppercase mt-1"
            >
              ARTICLE
            </div>
          </div>
          <div class="text-center">
            <div class="text-xl font-bold text-base-content/80 leading-none">
              {stats.totalTags}
            </div>
            <div
              class="text-[10px] text-base-content/40 font-bold uppercase mt-1"
            >
              TAG
            </div>
          </div>
          <div class="text-center">
            <div class="text-xl font-bold text-base-content/80 leading-none">
              {stats.daysActive}
            </div>
            <div
              class="text-[10px] text-base-content/40 font-bold uppercase mt-1"
            >
              DAY
            </div>
          </div>
        </div>
      </div>

      <BlogHeatmapSection heatmap={heatmap} />

      <!-- Navigation Section -->
      <div class="navigation-section px-4 mb-4">
        <nav class="flex flex-col gap-1">
          <button
            class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-base-200 text-base-content/70 active"
            data-view="article"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              ></path>
            </svg>
            <span>Article</span>
          </button>
          <button
            class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-base-200 text-base-content/70"
            data-view="moment"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span>Moment</span>
          </button>
          <button
            class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-base-200 text-base-content/70"
            data-view="note"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"
              ></path>
            </svg>
            <span>Note</span>
          </button>
        </nav>
      </div>

      <BlogTagSection tagTree={tagTree} />
    </div>
  </div>
</aside>

<script>
  const drawer = document.getElementById("drawer-sidebar");
  const closeButton = document.getElementById("drawer-close");

  let isOpen = true; // 默认打开

  function toggleDrawer() {
    isOpen = !isOpen;

    if (isOpen) {
      // 打开：sidebar显示
      drawer?.style.setProperty("width", "320px");
      // Dispatch event to notify content area to adjust
      const event = new CustomEvent("drawer-state-changed", {
        detail: { isOpen: true },
      });
      window.dispatchEvent(event);
    } else {
      // 关闭：sidebar隐藏
      drawer?.style.setProperty("width", "0");
      // Dispatch event to notify content area to adjust
      const event = new CustomEvent("drawer-state-changed", {
        detail: { isOpen: false },
      });
      window.dispatchEvent(event);
    }
  }

  // Listen for toggle event from DrawerToggle
  window.addEventListener("toggle-drawer", toggleDrawer);

  // Close drawer when clicking close button
  closeButton?.addEventListener("click", toggleDrawer);

  // ============================================
  // 视图切换逻辑
  // ============================================
  const navItems = document.querySelectorAll(".nav-item");
  navItems.forEach((item) => {
    item.addEventListener("click", () => {
      const view = item.getAttribute("data-view");

      // Debug log to trace clicks
      console.log('[Sidebar] nav click ->', view, item);

      // 更新UI状态
      navItems.forEach((n) => {
        n.classList.remove("active", "bg-base-200", "text-primary");
        n.classList.add("text-base-content/70");
      });
      item.classList.add("active", "bg-base-200", "text-primary");
      item.classList.remove("text-base-content/70");

      // 派发事件
      const event = new CustomEvent("view-changed", {
        detail: { view },
      });
      window.dispatchEvent(event);
    });
  });

  // ============================================
  // 标签树展开/折叠功能
  // ============================================
  document.querySelectorAll(".tag-toggle").forEach((toggleButton) => {
    toggleButton.addEventListener("click", () => {
      const listItem = toggleButton.closest("li");
      const children = listItem?.querySelector(":scope > .tag-children");
      if (!children) return;

      // 切换展开状态
      const expanded = toggleButton.getAttribute("data-expanded") !== "false";
      const nextExpanded = !expanded;
      toggleButton.setAttribute("data-expanded", `${nextExpanded}`);
      toggleButton.setAttribute("aria-expanded", `${nextExpanded}`);
      toggleButton.textContent = nextExpanded ? "▾" : "▸";
      children.classList.toggle("hidden", !nextExpanded);
    });
  });
</script>

<style>
  .drawer-sidebar,
  .drawer-sidebar * {
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
  }

  .drawer-sidebar::-webkit-scrollbar,
  .drawer-sidebar *::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
  }
</style>
