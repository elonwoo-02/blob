---
// BlogDrawerSidebar.astro - Sidebar for blog page
import BlogHeatmapSection from "./BlogHeatmapSection.astro";
import NavigationSection from "../navigation/NavigationSection.astro";
import BlogTagSection from "./BlogTagSection.astro";

const { heatmap, tagTree } = Astro.props;
---

<aside
  id="drawer-sidebar"
  class="drawer-sidebar fixed top-0 left-0 h-screen w-80 bg-base-100 z-40 overflow-y-auto ml-[-320px]"
  style="transition: margin-left 500ms cubic-bezier(0.4, 0, 0.2, 1);"
>
  <div class="drawer-content flex flex-col h-full">
    <!-- Header -->
    <div class="drawer-header p-4 flex justify-between items-center">
      <h2 class="text-lg font-bold">Blog</h2>
      <button
        id="drawer-close"
        class="p-2 hover:bg-base-200 rounded-full transition-all duration-300"
        aria-label="Close Sidebar"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Sections -->
    <div class="drawer-body flex-1 overflow-y-auto">
      <BlogHeatmapSection heatmap={heatmap} />
      <NavigationSection />
      <BlogTagSection tagTree={tagTree} />
    </div>
  </div>
</aside>

<script>
  const drawer = document.getElementById("drawer-sidebar");
  const closeButton = document.getElementById("drawer-close");

  let isOpen = false;

  function toggleDrawer() {
    isOpen = !isOpen;

    if (isOpen) {
      drawer?.style.setProperty("margin-left", "0");
    } else {
      drawer?.style.setProperty("margin-left", "-320px");
    }

    // Dispatch event to notify content area to adjust
    const event = new CustomEvent("drawer-state-changed", {
      detail: { isOpen },
    });
    window.dispatchEvent(event);
  }

  // Listen for toggle event from DrawerToggle
  window.addEventListener("toggle-drawer", toggleDrawer);

  // Close drawer when clicking close button
  closeButton?.addEventListener("click", toggleDrawer);

  // ============================================
  // 标签树展开/折叠功能
  // ============================================
  document.querySelectorAll(".tag-toggle").forEach((toggleButton) => {
    toggleButton.addEventListener("click", () => {
      const listItem = toggleButton.closest("li");
      const children = listItem?.querySelector(":scope > .tag-children");
      if (!children) return;

      // 切换展开状态
      const expanded = toggleButton.getAttribute("data-expanded") !== "false";
      const nextExpanded = !expanded;
      toggleButton.setAttribute("data-expanded", `${nextExpanded}`);
      toggleButton.setAttribute("aria-expanded", `${nextExpanded}`);
      toggleButton.textContent = nextExpanded ? "▾" : "▸";
      children.classList.toggle("hidden", !nextExpanded);
    });
  });
</script>

<style>
  .drawer-sidebar,
  .drawer-sidebar * {
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
  }

  .drawer-sidebar::-webkit-scrollbar,
  .drawer-sidebar *::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
  }
</style>
