---
// NoteView.astro - Micro-notes list layout
import { notes } from '../../data/notes';
import ContentView from './ContentView.astro';

interface Props {
  hidden?: boolean;
}

const { hidden = false } = Astro.props;

// Sort notes by date descending
const sortedNotes = [...notes].sort((a, b) => b.date.getTime() - a.date.getTime());

// Helper to expand tag paths (consistent with ArticleView)
const expandTagPaths = (tag: string) => {
  const segments = tag.split('/').map((s) => s.trim()).filter(Boolean);
  return segments.map((_, i) => segments.slice(0, i + 1).join('/'));
};

const getNoteTagPaths = (tags: string[]) =>
  [...new Set(tags.flatMap((tag) => expandTagPaths(tag)))].join('|');

const formatTime = (date: Date) => {
  return date.toLocaleDateString('zh-CN', { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit' 
  }) + ' ' + date.toLocaleTimeString('zh-CN', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
};
---

<ContentView 
  viewId="note-view" 
  title="NOTE" 
  count={sortedNotes.length}
  hidden={hidden}
>
  <Fragment slot="header-right">
    <!-- Active Tag Panel (Sync with ArticleView logic) -->
    <div id="note-active-tag-panel" class="hidden items-center gap-2 px-3 py-1.5 rounded-lg bg-[#3A7A8F]/10 text-[#3A7A8F] text-sm animate-in fade-in slide-in-from-top-2">
       <span class="font-medium">Filter:</span>
       <span id="note-active-tag-name" class="font-bold"></span>
       <button id="note-clear-tag-filter" type="button" class="ml-2 opacity-60 hover:opacity-100" aria-label="Clear filter">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
       </button>
    </div>
  </Fragment>

  <div id="note-list" class="space-y-4 w-[600px]">
    {sortedNotes.map((note) => (
      <article 
        class="note-card bg-base-100 rounded-xl p-5 shadow-sm border border-base-200/60"
        data-note-card
        data-tags={getNoteTagPaths(note.tags)}
      >
        <!-- Time meta -->
        <div class="flex items-center justify-between mb-3 text-xs text-base-content/40 font-mono border-b border-base-100 pb-2">
           <time datetime={note.date.toISOString()}>
             {formatTime(note.date)}
           </time>
        </div>

        <!-- Content -->
        <div class="mb-3 text-sm text-base-content/80 leading-relaxed whitespace-pre-wrap">
          {note.content}
        </div>

        <!-- Tags -->
        <div class="flex flex-wrap gap-2">
          {note.tags.map((tag) => (
            <button class="note-tag-btn text-xs text-[#3A7A8F]/80 hover:text-[#3A7A8F] hover:bg-[#3A7A8F]/5 px-1.5 py-0.5 rounded transition-colors" data-tag={tag}>
              #{tag}
            </button>
          ))}
        </div>
      </article>
    ))}
  </div>

  <!-- Empty state -->
  <div id="note-empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
     <div class="w-16 h-16 rounded-full bg-base-200/50 flex items-center justify-center mb-4 text-base-content/30">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
     </div>
     <p class="text-base-content/60">No notes found.</p>
     <button id="note-clear-tag-filter-empty" class="btn btn-link btn-sm mt-2 text-primary">Show all</button>
  </div>
</ContentView>

<script>
  // Filtering logic for NoteView
  const activeTagPanel = document.getElementById('note-active-tag-panel');
  const activeTagName = document.getElementById('note-active-tag-name');
  const clearFilterBtn = document.getElementById('note-clear-tag-filter');
  const clearFilterBtnEmpty = document.getElementById('note-clear-tag-filter-empty');
  const noteCards = Array.from(document.querySelectorAll('[data-note-card]'));
  const emptyState = document.getElementById('note-empty-state');
  
  const applyNoteTagFilter = (tag: string) => {
    let visibleCount = 0;
    
    noteCards.forEach((card) => {
      const tags = (card.getAttribute('data-tags') || '').split('|');
      const matched = !tag || tags.some((v) => v === tag || v.startsWith(`${tag}/`));
      
      if (matched) {
         card.classList.remove('hidden');
         visibleCount++;
      } else {
         card.classList.add('hidden');
      }
    });

    if (activeTagPanel && activeTagName) {
      if (tag) {
         activeTagPanel.classList.remove('hidden');
         activeTagPanel.classList.add('flex');
         activeTagName.textContent = `#${tag}`;
      } else {
         activeTagPanel.classList.add('hidden');
         activeTagPanel.classList.remove('flex');
      }
    }

    if (emptyState) {
       emptyState.classList.toggle('hidden', visibleCount > 0);
       emptyState.classList.toggle('flex', visibleCount === 0);
    }
  };

  document.querySelectorAll('.note-tag-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      applyNoteTagFilter(btn.getAttribute('data-tag') || '');
    });
  });

  const clearFilter = () => applyNoteTagFilter('');
  clearFilterBtn?.addEventListener('click', clearFilter);
  clearFilterBtnEmpty?.addEventListener('click', clearFilter);

  // Global event listener for sidebar
  document.querySelectorAll('.tag-nav-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-tag') || '';
      applyNoteTagFilter(tag);
    });
  });
</script>
