---
import '../styles/global.css';
import BaseLayout from "../layouts/BaseLayout.astro";
import TagTree from "../components/menu/TagTree.astro";

// 抽屉导航项：桌面抽屉与移动抽屉共用，避免两套菜单文案分叉维护。
const drawerItems = ['Memo', 'Daily Review', 'Tags', 'Trash'];

// 笔记数据：用于渲染主内容区卡片流。
// 实际项目中可替换为 API 返回、数据库数据或 Astro 内容集合。
const notes = [
  {
    time: 'Pinned · 2026-02-13 20:35',
    tag: '#philosophy',
    content:
      'Treat learning like short-form streams: tiny and frequent. Focus on one thing at a time, remove vanity goals, and keep moving with honest momentum.',
  },
  {
    time: '2026-02-13 15:38',
    tag: '#work',
    content:
      'Ship the first onboarding draft this week. Keep it concise: access setup, troubleshooting path, and one quick-start checklist for day one.',
  },
  {
    time: '2026-02-12 09:14',
    tag: '#daily',
    content:
      'The afternoon felt lighter after batching replies into two windows. Keep the same rhythm tomorrow and protect two deep-focus blocks.',
  },
  {
    time: '2026-02-11 23:07',
    tag: '#ideas',
    content:
      'A simple rule for notes: write just enough detail that tomorrow-you can act on it in under one minute.',
  },
];
---

<BaseLayout>
  <!--
    主壳层布局：
    - 左：抽屉区域（iPad/桌面）
    - 右：内容区域（卡片流）
  -->
  <main id='flomoShell' class='flex w-full gap-4'>
    <!--
      桌面抽屉（md 及以上）：
      - 初始宽度 240px
      - 支持动态收起/展开（通过脚本切换宽度和可见性）
    -->
    <div>
      <!-- data-drawer-toggle：统一抽屉切换触发器（桌面/移动共用）todo: 放到右上角 -->
      <button
        type='button'
        data-drawer-toggle
        aria-label='toggle drawer'
        aria-expanded='true'
        class='rounded-xl transition-colors duration-150 ease-in-out hover:bg-[#FAFAF8]'
      >
        <svg class='h-4.5 w-4.5' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.8'>
          <path stroke-linecap='round' stroke-linejoin='round' d='M4 6h16M4 12h16M4 18h16' />
        </svg>
      </button>
      <button>

      </button>
      <button>

      </button>
    </div>

    <aside
      id='flomoDesktopDrawer'
      class='hidden w-60 shrink-0 overflow-hidden transition-[width,opacity] duration-300 ease-in-out md:flex md:flex-col'
    >
      <div class='flex h-full flex-col bg-[#F5F5F3]'>
        <div class='mb-10 flex items-center justify-between px-3 text-[#999999]'>
          <!-- data-drawer-label：桌面收起时统一隐藏的文本节点 -->
          <span data-drawer-label class='text-[13px] tracking-wide'>memo</span>
        </div>

        <!-- data-drawer-section：收起时整块隐藏（统计信息区） -->
        <div data-drawer-section class='mb-8 px-3'>
          <p class='text-[34px] font-semibold leading-none tracking-tight text-[#333333]/85'>1603</p>
          <p class='mt-2 text-[12px] uppercase tracking-[0.24em] text-[#999999]'>notes</p>
        </div>
        <TagTree/>
        <nav class='space-y-2 px-1 text-[14px]'>
          {
            // 首项作为当前激活态；其余为常规态。
            drawerItems.map((item, index) => (
              <a
                href='#'
                data-drawer-item
                class={`block rounded-[18px] px-4 py-2.5 transition-colors duration-150 ease-in-out ${
                  index === 0 ? 'bg-[#ECECEA] font-medium text-[#333333]/85' : 'text-[#666666] hover:bg-[#FAFAF8]'
                }`}
              >
                <!-- 项目文本单独包裹，便于收起时隐藏文字保留点击热区 -->
                <span data-drawer-label>{item}</span>
              </a>
            ))
          }
        </nav>
      </div>
    </aside>

    <!-- 主内容区：顶部标题 + 单列卡片流 -->
    <section class='mx-auto flex min-w-0 w-full max-w-190 flex-1 flex-col'>
      <header class='relative mb-8 flex items-center justify-center'>
        <!--
          头部抽屉按钮：
          - 桌面：切换左侧抽屉展开/收起
          - 移动：打开/关闭侧滑抽屉
          - 搜索框
        -->
        <!--<button-->
        <!--  type='button'-->
        <!--  data-drawer-toggle-->
        <!--  aria-label='toggle drawer'-->
        <!--  aria-expanded='true'-->
        <!--  class='absolute left-0 inline-flex h-10 w-10 items-center justify-center rounded-xl text-[#999999] transition-colors duration-150 ease-in-out hover:bg-[#FAFAF8]'-->
        <!--&gt;-->
        <!--  <svg class='h-5 w-5' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.8'>-->
        <!--    <path stroke-linecap='round' stroke-linejoin='round' d='M4 6h16M4 12h16M4 18h16' />-->
        <!--  </svg>-->
        <!--</button>-->
        <!--<h1 class='text-[18px] font-semibold text-[#333333]'>flomo</h1>-->
        <!--todo: 搜索框-->
      </header>

      <!-- 卡片流：严格单列，保持 flomo 风格的阅读节奏 -->
      <div class=''>
        {notes.map((note) => (
          <article
            class='my-1 relative rounded-3xl bg-black/10 px-6 py-6 shadow-[0_8px_24px_rgba(0,0,0,0.04)] duration-150 ease-in-out'
          >
            <!-- 右上角更多按钮：当前仅占位，后续可接菜单行为 -->
            <button
              type='button'
              aria-label='more'
              class='absolute right-4 top-4 h-7 w-7 rounded-full text-[#B5B5B5] transition-colors duration-150 ease-in-out hover:bg-[#FAFAF8]'
            >
              ···
            </button>
            <p class='mb-3 text-[13px] text-[#666666]'>{note.time}</p>
            <div class='mb-3 flex items-center'>
              <span class='inline-flex rounded-full bg-[#EAF2FF] px-3 py-1 text-[12px] font-medium text-[#4A78FF]'>
                {note.tag}
              </span>
            </div>
            <p class='pr-8 text-[16px] leading-[1.62] text-[#333333]'>{note.content}</p>
          </article>
        ))}
      </div>
    </section>
  </main>

  <!-- 移动端遮罩：打开侧滑抽屉时显示，点击遮罩可关闭 -->
  <div
    id='flomoMobileBackdrop'
    class='pointer-events-none fixed inset-0 z-30 bg-black/10 opacity-0 transition-opacity duration-300 ease-in-out md:hidden'
  ></div>

  <!-- 移动端侧滑抽屉（md 以下）：默认隐藏在左侧 -->
  <aside
    id='flomoMobileDrawer'
    class='fixed inset-y-0 left-0 z-40 w-60 -translate-x-full bg-[#F5F5F3] px-3 py-8 transition-transform duration-300 ease-in-out md:hidden'
    aria-hidden='true'
  >
    <div class='mb-8 flex items-center justify-between text-[#999999]'>
      <span class='text-[13px] tracking-wide'>memo</span>
      <!-- data-drawer-close：显式关闭按钮 -->
      <button
        type='button'
        data-drawer-close
        aria-label='close drawer'
        class='inline-flex h-9 w-9 items-center justify-center rounded-xl transition-colors duration-150 ease-in-out hover:bg-[#FAFAF8]'
      >
        <svg class='h-4 w-4' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
          <path stroke-linecap='round' stroke-linejoin='round' d='M6 6l12 12M18 6L6 18' />
        </svg>
      </button>
    </div>

    <div class='mb-8'>
      <p class='text-[34px] font-semibold leading-none tracking-tight text-[#333333]/85'>1603</p>
      <p class='mt-2 text-[12px] uppercase tracking-[0.24em] text-[#999999]'>notes</p>
    </div>

    <nav class='space-y-2 text-[14px]'>
      {
        // 与桌面端共享 drawerItems，保持结构与顺序一致。
        drawerItems.map((item, index) => (
          <a
            href='#'
            class={`block rounded-[18px] px-4 py-2.5 ${
              index === 0 ? 'bg-[#ECECEA] font-medium text-[#333333]/85' : 'text-[#666666]'
            }`}
          >
            {item}
          </a>
        ))
      }
    </nav>
  </aside>

  <script is:inline>
    // ====================
    // Drawer 交互逻辑说明
    // ====================
    // 目标：
    // 1) 桌面端（md+）支持抽屉展开/收起，并记住用户偏好。
    // 2) 移动端（< md）支持侧滑抽屉，支持按钮/遮罩/Esc 关闭。

    // 桌面抽屉节点（用于宽度和可见性切换）
    const desktopDrawer = document.getElementById('flomoDesktopDrawer');
    // 移动抽屉节点（用于平移动画切换）
    const mobileDrawer = document.getElementById('flomoMobileDrawer');
    // 移动遮罩节点（用于点击关闭）
    const mobileBackdrop = document.getElementById('flomoMobileBackdrop');
    // 全部切换按钮（头部 + 抽屉内按钮）
    const toggleButtons = document.querySelectorAll('[data-drawer-toggle]');
    // 全部关闭按钮（移动端）
    const closeButtons = document.querySelectorAll('[data-drawer-close]');
    // 桌面抽屉中“收起时需隐藏”的文本节点
    const desktopLabels = document.querySelectorAll('#flomoDesktopDrawer [data-drawer-label]');
    // 桌面抽屉中“收起时需隐藏”的区块节点
    const desktopSections = document.querySelectorAll('#flomoDesktopDrawer [data-drawer-section]');
    // 桌面抽屉菜单项节点（收起时调整样式）
    const desktopItems = document.querySelectorAll('#flomoDesktopDrawer [data-drawer-item]');
    // 与 Tailwind md 断点一致（768px）
    const mdMedia = window.matchMedia('(min-width: 768px)');
    // 桌面状态：true 表示展开，false 表示收起
    let desktopOpen = true;

    // 从本地存储恢复桌面状态：
    // - open: 展开
    // - closed: 收起
    try {
      const cached = localStorage.getItem('flomo:drawer:desktop');
      if (cached === 'closed') desktopOpen = false;
    } catch {
      // 存储不可用时静默降级，不影响主流程。
    }

    // 同步所有 toggle 按钮的 aria-expanded，保证可访问性状态一致。
    const syncToggleAria = (expanded) => {
      toggleButtons.forEach((button) => {
        button.setAttribute('aria-expanded', String(expanded));
      });
    };

    // 应用桌面抽屉状态：
    // - 切换宽度（240px / 0）
    // - 切换透明度和可点击能力
    // - 收起时隐藏文本与统计区
    const applyDesktopState = () => {
      if (!desktopDrawer) return;
      desktopDrawer.classList.toggle('md:w-60', desktopOpen);
      desktopDrawer.classList.toggle('md:w-0', !desktopOpen);
      desktopDrawer.classList.toggle('md:opacity-100', desktopOpen);
      desktopDrawer.classList.toggle('md:opacity-0', !desktopOpen);
      desktopDrawer.classList.toggle('md:pointer-events-auto', desktopOpen);
      desktopDrawer.classList.toggle('md:pointer-events-none', !desktopOpen);

      desktopLabels.forEach((node) => {
        node.classList.toggle('md:hidden', !desktopOpen);
      });

      desktopSections.forEach((node) => {
        node.classList.toggle('md:hidden', !desktopOpen);
      });

      desktopItems.forEach((node) => {
        // 收起时减小菜单项占位，避免视觉拥挤。
        node.classList.toggle('md:px-0', !desktopOpen);
        node.classList.toggle('md:py-2', !desktopOpen);
        node.classList.toggle('md:bg-transparent', !desktopOpen);
      });
    };

    // 打开移动抽屉：滑入 + 遮罩激活。
    const openMobile = () => {
      if (!mobileDrawer || !mobileBackdrop) return;
      mobileDrawer.classList.remove('-translate-x-full');
      mobileDrawer.classList.add('translate-x-0');
      mobileDrawer.setAttribute('aria-hidden', 'false');
      mobileBackdrop.classList.remove('pointer-events-none', 'opacity-0');
    };

    // 关闭移动抽屉：滑出 + 遮罩关闭。
    const closeMobile = () => {
      if (!mobileDrawer || !mobileBackdrop) return;
      mobileDrawer.classList.add('-translate-x-full');
      mobileDrawer.classList.remove('translate-x-0');
      mobileDrawer.setAttribute('aria-hidden', 'true');
      mobileBackdrop.classList.add('pointer-events-none', 'opacity-0');
    };

    // 统一切换入口：
    // - 桌面端：切换 desktopOpen 并持久化
    // - 移动端：切换 open/close
    const handleToggle = () => {
      if (mdMedia.matches) {
        desktopOpen = !desktopOpen;
        applyDesktopState();
        syncToggleAria(desktopOpen);
        try {
          localStorage.setItem('flomo:drawer:desktop', desktopOpen ? 'open' : 'closed');
        } catch {
          // 存储失败时忽略，交互仍可正常使用。
        }
        return;
      }

      const mobileOpened = mobileDrawer && mobileDrawer.classList.contains('translate-x-0');
      if (mobileOpened) {
        closeMobile();
        syncToggleAria(false);
        return;
      }

      openMobile();
      syncToggleAria(true);
    };

    // 绑定“切换抽屉”按钮。
    toggleButtons.forEach((button) => {
      button.addEventListener('click', handleToggle);
    });

    // 绑定“关闭抽屉”按钮（移动端）。
    closeButtons.forEach((button) => {
      button.addEventListener('click', () => {
        closeMobile();
        syncToggleAria(false);
      });
    });

    // 点击遮罩关闭移动抽屉。
    mobileBackdrop?.addEventListener('click', () => {
      closeMobile();
      syncToggleAria(false);
    });

    // Esc 快捷关闭（仅影响移动抽屉）。
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeMobile();
        syncToggleAria(false);
      }
    });

    // 断点变化时：
    // - 强制关闭移动抽屉（防止跨断点残留）
    // - 恢复桌面抽屉状态渲染
    mdMedia.addEventListener('change', () => {
      closeMobile();
      applyDesktopState();
      syncToggleAria(desktopOpen);
    });

    // 首次加载初始化。
    applyDesktopState();
    syncToggleAria(desktopOpen);
  </script>
</BaseLayout>
