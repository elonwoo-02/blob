---
import '../styles/global.css';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { buildTagTree, tagToSlug } from '../utils/tags';
import TagTreeNode from '../components/TagTreeNode.astro';

const pageTitle = 'åšå®¢';
const allPosts = await getCollection('blog');
const sortedPosts = [...allPosts].sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);
const tagTree = buildTagTree(sortedPosts);

const startDate = new Date();
startDate.setDate(startDate.getDate() - 364);
const formatDate = (date: Date) =>
  `${date.getFullYear()}-${`${date.getMonth() + 1}`.padStart(2, '0')}-${`${date.getDate()}`.padStart(2, '0')}`;

const heatmap = Array.from({ length: 53 }, (_, weekIndex) =>
  Array.from({ length: 7 }, (_, dayIndex) => {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + weekIndex * 7 + dayIndex);
    const raw = (weekIndex * 3 + dayIndex * 5 + date.getDate()) % 10;
    const level = raw < 2 ? 0 : raw < 4 ? 1 : raw < 7 ? 2 : raw < 9 ? 3 : 4;
    return {
      date: formatDate(date),
      count: level * 2,
      level
    };
  })
);

const levelText = ['0 æ¬¡æäº¤', '1-2 æ¬¡æäº¤', '3-5 æ¬¡æäº¤', '6-8 æ¬¡æäº¤', '9+ æ¬¡æäº¤'];
---

<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
  </head>

  <body>
    <BaseLayout pageTitle={pageTitle}>
      <section class="space-y-4">
        <div class="rounded-3xl border border-base-300 bg-base-100 p-6 shadow-sm">
          <div class="mb-4 flex items-center justify-between gap-3">
            <div>
              <h1 class="text-2xl font-bold">Blog Timeline</h1>
              <p class="text-sm text-base-content/70">GitHub é£æ ¼è´¡çŒ®çƒ­åŠ›å›¾</p>
            </div>
            <a class="btn btn-sm btn-outline" href="https://github.com/" target="_blank" rel="noreferrer">è®¿é—® GitHub</a>
          </div>

          <div class="overflow-x-auto pb-2">
            <div class="grid min-w-[860px] grid-flow-col gap-1">
              {heatmap.map((week) => (
                <div class="grid grid-rows-7 gap-1">
                  {week.map((day) => (
                    <div
                      class:list={[
                        'h-3 w-3 rounded-[3px] border border-black/5',
                        day.level === 0 && 'bg-base-300/70',
                        day.level === 1 && 'bg-emerald-200',
                        day.level === 2 && 'bg-emerald-400',
                        day.level === 3 && 'bg-emerald-600',
                        day.level === 4 && 'bg-emerald-800'
                      ]}
                      title={`${day.date} Â· ${day.count} commits`}
                      aria-label={`${day.date} ${levelText[day.level]}`}
                    ></div>
                  ))}
                </div>
              ))}
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-3 text-xs text-base-content/70">
            <span>Less</span>
            {levelText.map((text, level) => (
              <span class="inline-flex items-center gap-1">
                <span
                  class:list={[
                    'h-3 w-3 rounded-[3px] border border-black/5',
                    level === 0 && 'bg-base-300/70',
                    level === 1 && 'bg-emerald-200',
                    level === 2 && 'bg-emerald-400',
                    level === 3 && 'bg-emerald-600',
                    level === 4 && 'bg-emerald-800'
                  ]}
                ></span>{text}
              </span>
            ))}
            <span>More</span>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="drawer lg:drawer-open">
          <input id="tag-drawer" type="checkbox" class="drawer-toggle" />
          <div class="drawer-content">
            <div class="mb-4 lg:hidden">
              <label for="tag-drawer" class="btn btn-outline btn-sm">æ‰“å¼€æ ‡ç­¾æŠ½å±‰</label>
            </div>
            <div class="space-y-4">
          {sortedPosts.map((post) => (
            <article class="rounded-3xl border border-base-300 bg-base-100 p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
              <div class="flex items-center gap-3 text-sm text-base-content/70">
                <div class="avatar placeholder">
                  <div class="w-9 rounded-full bg-neutral text-neutral-content">
                    <span>{post.data.author.slice(0, 1)}</span>
                  </div>
                </div>
                <div>
                  <p class="font-medium text-base-content">{post.data.author}</p>
                  <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </time>
                </div>
              </div>

              <h3 class="mt-3 text-xl font-semibold">
                <a class="link-hover" href={`/posts/${post.id}/`}>{post.data.title}</a>
              </h3>
              <p class="mt-2 text-sm leading-6 text-base-content/80">{post.data.description}</p>

              <div class="mt-3 flex flex-wrap gap-2">
                {post.data.tags.map((tag: string) => (
                  <a class="badge badge-outline" href={`/tags/${tagToSlug(tag)}`}>#{tag}</a>
                ))}
              </div>

              <div class="mt-4 flex items-center justify-end gap-2">
                <button class="btn btn-ghost btn-sm gap-1 text-base-content/80" type="button">â¤ï¸ ç‚¹èµ</button>
                <button class="btn btn-ghost btn-sm gap-1 text-base-content/80" type="button">ğŸ” è½¬å‘</button>
                <button class="btn btn-primary btn-sm" type="button">â• æ·»åŠ åˆ° DOCK</button>
              </div>
            </article>
          ))}
            </div>
          </div>
          <div class="drawer-side z-20">
            <label for="tag-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="min-h-full w-80 rounded-r-3xl border-r border-base-300 bg-base-100 p-5 shadow-sm lg:rounded-3xl lg:border lg:shadow-sm">
              <h2 class="mb-4 text-lg font-semibold">Tags</h2>
              <ul class="space-y-2">
                {tagTree.map((tag) => <TagTreeNode node={tag} />)}
              </ul>
            </aside>
          </div>
        </div>
      </section>
    </BaseLayout>
  </body>
</html>
