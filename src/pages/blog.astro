---
import '../styles/global.css';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { buildTagTree, tagToSlug } from '../utils/tags';
import TagTreeNode from '../components/TagTreeNode.astro';
import GithubIcon from "../components/icon/GithubIcon.astro";
import PostActionBar from '../components/PostActionBar.astro';

const pageTitle = '';
const allPosts = await getCollection('blog');
const sortedPosts = [...allPosts].sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);
const tagTree = buildTagTree(sortedPosts);

const expandTagPaths = (tag: string) => {
  const segments = tag
    .split('/')
    .map((segment) => segment.trim())
    .filter(Boolean);
  return segments.map((_, index) => segments.slice(0, index + 1).join('/'));
};

const getPostTagPaths = (tags: string[]) =>
  [...new Set(tags.flatMap((tag) => expandTagPaths(tag)))].join('|');

const startDate = new Date();
startDate.setDate(startDate.getDate() - 364);
const formatDate = (date: Date) =>
  `${date.getFullYear()}-${`${date.getMonth() + 1}`.padStart(2, '0')}-${`${date.getDate()}`.padStart(2, '0')}`;

const heatmap = Array.from({ length: 53 }, (_, weekIndex) =>
  Array.from({ length: 7 }, (_, dayIndex) => {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + weekIndex * 7 + dayIndex);
    const raw = (weekIndex * 3 + dayIndex * 5 + date.getDate()) % 10;
    const level = raw < 2 ? 0 : raw < 4 ? 1 : raw < 7 ? 2 : raw < 9 ? 3 : 4;
    return {
      date: formatDate(date),
      count: level * 2,
      level
    };
  })
);

const levelText = ['0 次提交', '1-2 次提交', '3-5 次提交', '6-8 次提交', '9+ 次提交'];
---

<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
  </head>

  <body>
    <BaseLayout pageTitle={pageTitle}>
      <section class="space-y-4">
        <div class="rounded-3xl border border-base-300 bg-base-100 p-6 shadow-sm">
          <div class="mb-4 flex items-center justify-between gap-3">
            <div>
              <h1 class="text-2xl font-bold">Blog Timeline</h1>
              <p class="text-sm text-base-content/70">GitHub 风格贡献热力图</p>
            </div>
            <a class="w-10 h-10" href="https://github.com/" target="_blank" rel="noreferrer">
              <GithubIcon/>
            </a>
          </div>

          <div class="overflow-x-auto pb-2">
            <div class="grid min-w-[860px] grid-flow-col gap-1">
              {heatmap.map((week) => (
                <div class="grid grid-rows-7 gap-1">
                  {week.map((day) => (
                    <div
                      class:list={[
                        'h-3 w-3 rounded-[3px] border border-black/5',
                        day.level === 0 && 'bg-base-300/70',
                        day.level === 1 && 'bg-emerald-200',
                        day.level === 2 && 'bg-emerald-400',
                        day.level === 3 && 'bg-emerald-600',
                        day.level === 4 && 'bg-emerald-800'
                      ]}
                      title={`${day.date} · ${day.count} commits`}
                      aria-label={`${day.date} ${levelText[day.level]}`}
                    ></div>
                  ))}
                </div>
              ))}
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-3 text-xs text-base-content/70">
            <span>Less</span>
            {levelText.map((text, level) => (
              <span class="inline-flex items-center gap-1">
                <span
                  class:list={[
                    'h-3 w-3 rounded-[3px] border border-black/5',
                    level === 0 && 'bg-base-300/70',
                    level === 1 && 'bg-emerald-200',
                    level === 2 && 'bg-emerald-400',
                    level === 3 && 'bg-emerald-600',
                    level === 4 && 'bg-emerald-800'
                  ]}
                ></span>{text}
              </span>
            ))}
            <span>More</span>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="drawer lg:drawer-open blog-drawer" id="blog-drawer-layout">
          <input id="tag-drawer" type="checkbox" class="drawer-toggle" />
          <div class="drawer-content">
            <div class="mb-4 flex flex-wrap items-center justify-between gap-3">
              <div class="lg:hidden">
                <label for="tag-drawer" class="btn btn-outline btn-sm">打开标签抽屉</label>
              </div>
              <div id="active-tag-panel" class="hidden flex-1 rounded-2xl border border-primary/30 bg-primary/5 px-4 py-2 text-sm">
                当前筛选：<span id="active-tag-name" class="font-semibold"></span>
                <button id="clear-tag-filter" type="button" class="btn btn-ghost btn-xs ml-2">清除</button>
              </div>
            </div>
            <div id="post-list" class="space-y-4">
          {sortedPosts.map((post) => (
            <article
              class="rounded-3xl border border-base-300 bg-base-100 p-5 shadow-sm transition hover:shadow-md"
              data-post-card
              data-post-link={`/posts/${post.id}/`}
              data-tags={getPostTagPaths(post.data.tags)}
              data-post-id={post.id}
            >
              <div class="flex items-center gap-3 text-sm text-base-content/70">
                <div class="avatar placeholder">
                  <div class="w-9 rounded-full bg-neutral text-neutral-content">
                    <span>{post.data.author.slice(0, 1)}</span>
                  </div>
                </div>
                <div>
                  <p class="font-medium text-base-content">{post.data.author}</p>
                  <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </time>
                </div>
              </div>

              <h3 class="mt-3 text-xl font-semibold">
                <a class="link-hover" href={`/posts/${post.id}/`}>{post.data.title}</a>
              </h3>
              <p class="mt-2 text-sm leading-6 text-base-content/80">{post.data.description}</p>

              <div class="mt-3 flex flex-wrap gap-2">
                {post.data.tags.map((tag: string) => (
                  <button class="badge tag-filter-btn card-tag" data-tag={tag} data-tag-slug={tagToSlug(tag)} type="button">#{tag}</button>
                ))}
              </div>

              <div class="mt-4">
                <PostActionBar
                  likeCount={post.data.likeCount ?? 0}
                  shareCount={post.data.shareCount ?? 0}
                  docked={post.data.docked ?? false}
                />
              </div>
            </article>
          ))}
            </div>
            <p id="empty-filter-state" class="mt-6 hidden rounded-2xl border border-dashed border-base-300 bg-base-100 p-6 text-center text-base-content/70">暂无文章匹配该标签。</p>
          </div>
          <div class="drawer-side z-20 blog-drawer-side">
            <label for="tag-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="min-h-full w-80 rounded-r-3xl border-r border-base-300 bg-base-100 p-5 shadow-sm lg:rounded-3xl lg:border lg:shadow-sm">
              <div class="mb-4 flex items-center justify-between">
                <h2 class="text-lg font-semibold">Tags</h2>
                <button id="toggle-sidebar" class="btn btn-ghost btn-xs hidden lg:inline-flex" type="button" aria-label="收起标签侧边栏">⇥</button>
              </div>
              <ul id="tag-tree" class="space-y-2">
                {tagTree.map((tag) => <TagTreeNode node={tag} />)}
              </ul>
            </aside>
          </div>
        </div>
      </section>

      <div id="toast" class="toast hidden" role="status" aria-live="polite">
        <div class="toast-surface">已复制链接</div>
      </div>

      <script is:inline>
        const drawerLayout = document.getElementById('blog-drawer-layout');
        const sidebarToggle = document.getElementById('toggle-sidebar');
        const activeTagPanel = document.getElementById('active-tag-panel');
        const activeTagName = document.getElementById('active-tag-name');
        const clearFilterButton = document.getElementById('clear-tag-filter');
        const postCards = Array.from(document.querySelectorAll('[data-post-card]'));
        const tagNavButtons = Array.from(document.querySelectorAll('.tag-nav-btn'));
        const emptyState = document.getElementById('empty-filter-state');
        const toast = document.getElementById('toast');
        let toastTimer = null;
        const actionStoragePrefix = 'blog:action:';
        const canStore = (() => {
          try {
            localStorage.setItem(`${actionStoragePrefix}ping`, '1');
            localStorage.removeItem(`${actionStoragePrefix}ping`);
            return true;
          } catch (error) {
            return false;
          }
        })();

        const getStoredNumber = (key, fallback) => {
          if (!canStore) return fallback;
          const raw = localStorage.getItem(key);
          const value = raw === null ? NaN : Number(raw);
          return Number.isFinite(value) ? value : fallback;
        };

        const getStoredBool = (key, fallback) => {
          if (!canStore) return fallback;
          const raw = localStorage.getItem(key);
          if (raw === '1') return true;
          if (raw === '0') return false;
          return fallback;
        };

        const setStoredValue = (key, value) => {
          if (!canStore) return;
          localStorage.setItem(key, value);
        };

        const getInitialCount = (button) => {
          const raw = button.getAttribute('data-initial-count');
          const value = raw === null ? NaN : Number(raw);
          return Number.isFinite(value) ? value : 0;
        };

        const updateLabel = (button, isActive) => {
          const labelEl = button.querySelector('.post-action-label');
          if (!labelEl) return;
          const activeLabel = button.getAttribute('data-active-label') || labelEl.textContent || '';
          const inactiveLabel = button.getAttribute('data-inactive-label') || labelEl.textContent || '';
          labelEl.textContent = isActive ? activeLabel : inactiveLabel;
        };

        const updateCount = (button, count) => {
          const countEl = button.querySelector('.post-action-count');
          if (!countEl) return;
          countEl.textContent = `${count}`;
        };

        const showToast = (message) => {
          if (!toast) return;
          const surface = toast.querySelector('.toast-surface');
          if (surface) {
            surface.textContent = message;
          }
          toast.classList.remove('hidden');
          toast.classList.add('is-visible');
          if (toastTimer) window.clearTimeout(toastTimer);
          toastTimer = window.setTimeout(() => {
            toast.classList.remove('is-visible');
            toastTimer = window.setTimeout(() => {
              toast.classList.add('hidden');
            }, 220);
          }, 1600);
        };

        const applyTagFilter = (tag) => {
          let visibleCount = 0;
          postCards.forEach((card) => {
            const tags = (card.getAttribute('data-tags') || '').split('|');
            const matched = !tag || tags.some((value) => value === tag || value.startsWith(`${tag}/`));
            card.classList.toggle('hidden', !matched);
            if (matched) visibleCount += 1;
          });

          if (tagNavButtons.length > 0) {
            tagNavButtons.forEach((button) => {
              const buttonTag = button.getAttribute('data-tag') || '';
              button.classList.toggle('is-active', Boolean(tag) && buttonTag === tag);
            });
          }

          if (activeTagPanel && activeTagName) {
            activeTagPanel.classList.toggle('hidden', !tag);
            activeTagName.textContent = tag ? `#${tag}` : '';
          }

          if (emptyState) {
            emptyState.classList.toggle('hidden', visibleCount > 0);
          }
        };

        document.querySelectorAll('.tag-filter-btn').forEach((button) => {
          button.addEventListener('click', () => {
            applyTagFilter(button.getAttribute('data-tag') || '');
          });
        });

        if (clearFilterButton) {
          clearFilterButton.addEventListener('click', () => applyTagFilter(''));
        }

        document.querySelectorAll('.tag-toggle').forEach((toggleButton) => {
          toggleButton.addEventListener('click', () => {
            const listItem = toggleButton.closest('li');
            const children = listItem?.querySelector(':scope > .tag-children');
            if (!children) return;

            const expanded = toggleButton.getAttribute('data-expanded') !== 'false';
            const nextExpanded = !expanded;
            toggleButton.setAttribute('data-expanded', `${nextExpanded}`);
            toggleButton.setAttribute('aria-expanded', `${nextExpanded}`);
            toggleButton.textContent = nextExpanded ? '▾' : '▸';
            children.classList.toggle('hidden', !nextExpanded);
          });
        });

        if (sidebarToggle && drawerLayout) {
          sidebarToggle.addEventListener('click', () => {
            const collapsed = drawerLayout.classList.toggle('blog-sidebar-collapsed');
            sidebarToggle.textContent = collapsed ? '⇤' : '⇥';
          });
        }

        postCards.forEach((card) => {
          const postId = card.getAttribute('data-post-id');
          if (!postId) return;

          card.querySelectorAll('.post-action-btn').forEach((button) => {
            const action = button.getAttribute('data-action');
            if (!action) return;

            const baseCount = getInitialCount(button);
            const likeKey = `${actionStoragePrefix}like:${postId}`;
            const shareKey = `${actionStoragePrefix}share:${postId}`;
            const dockKey = `${actionStoragePrefix}dock:${postId}`;

            if (action === 'like') {
              let liked = getStoredBool(likeKey, button.classList.contains('is-active'));
              button.classList.toggle('is-active', liked);
              updateLabel(button, liked);
              updateCount(button, baseCount + (liked ? 1 : 0));

              button.addEventListener('click', (event) => {
                event.stopPropagation();
                liked = !liked;
                setStoredValue(likeKey, liked ? '1' : '0');
                button.classList.toggle('is-active', liked);
                updateLabel(button, liked);
                updateCount(button, baseCount + (liked ? 1 : 0));
              });
              return;
            }

            if (action === 'share') {
              let total = getStoredNumber(shareKey, baseCount);
              updateCount(button, total);

              const resolveShareUrl = () => {
                const href = card.getAttribute('data-post-link') || '';
                if (!href) return window.location.href;
                try {
                  return new URL(href, window.location.origin).toString();
                } catch (error) {
                  return window.location.href;
                }
              };

              const persistShare = () => {
                total += 1;
                setStoredValue(shareKey, `${total}`);
                updateCount(button, total);
              };

              button.addEventListener('click', async (event) => {
                event.stopPropagation();
                const shareUrl = resolveShareUrl();

                if (navigator.share) {
                  try {
                    await navigator.share({
                      title: document.title,
                      url: shareUrl
                    });
                    persistShare();
                  } catch (error) {
                    // User cancelled or share failed.
                  }
                  return;
                }

                if (navigator.clipboard?.writeText) {
                  try {
                    await navigator.clipboard.writeText(shareUrl);
                    persistShare();
                    showToast('已复制链接');
                    return;
                  } catch (error) {
                    // fall through
                  }
                }

                window.prompt('复制链接分享:', shareUrl);
              });
              return;
            }

            if (action === 'dock') {
              let docked = getStoredBool(dockKey, button.classList.contains('is-active'));
              button.classList.toggle('is-active', docked);
              updateLabel(button, docked);

              button.addEventListener('click', (event) => {
                event.stopPropagation();
                docked = !docked;
                setStoredValue(dockKey, docked ? '1' : '0');
                button.classList.toggle('is-active', docked);
                updateLabel(button, docked);
              });
            }
          });
        });

        const shouldIgnoreCardClick = (target) =>
          Boolean(target.closest('a, button, input, label, textarea, select, [role="button"]'));

        postCards.forEach((card) => {
          card.addEventListener('click', (event) => {
            if (shouldIgnoreCardClick(event.target)) return;
            const href = card.getAttribute('data-post-link');
            if (!href) return;
            window.location.href = href;
          });

          card.addEventListener('keydown', (event) => {
            if (event.key !== 'Enter' && event.key !== ' ') return;
            if (shouldIgnoreCardClick(event.target)) return;
            const href = card.getAttribute('data-post-link');
            if (!href) return;
            event.preventDefault();
            window.location.href = href;
          });

          card.setAttribute('tabindex', '0');
          card.setAttribute('role', 'link');
        });
      </script>

      <style is:inline>
        .toast {
          position: fixed;
          bottom: 1.5rem;
          right: 1.5rem;
          z-index: 60;
          pointer-events: none;
          opacity: 0;
          transform: translateY(6px);
          transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .toast.is-visible {
          opacity: 1;
          transform: translateY(0);
        }

        .toast-surface {
          background: hsl(var(--b1));
          border: 1px solid hsl(var(--bc) / 0.15);
          color: hsl(var(--bc));
          border-radius: 999px;
          padding: 0.55rem 0.9rem;
          font-size: 0.85rem;
          box-shadow: 0 10px 25px hsl(var(--bc) / 0.12);
        }

        [data-post-card] .card-tag:hover {
          color: hsl(var(--p));
        }

        .tag-nav-btn.is-active {
          background: hsl(var(--p) / 0.16);
          color: hsl(var(--p));
          border-radius: 999px;
          padding-left: 0.35rem;
          padding-right: 0.35rem;
        }

        @media (min-width: 1024px) {
          .blog-drawer .drawer-side > *:not(.drawer-overlay) {
            transition: width 0.2s ease;
          }

          .blog-sidebar-collapsed .blog-drawer-side aside {
            width: 3.5rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            overflow: hidden;
          }

          .blog-sidebar-collapsed .blog-drawer-side h2,
          .blog-sidebar-collapsed .blog-drawer-side #tag-tree {
            display: none;
          }
        }
      </style>

    </BaseLayout>
  </body>
</html>
