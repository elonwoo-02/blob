---
// ============================================
// 博客页面 - Blog Page
// ============================================
// 功能说明：
// 1. 支持Article和Moment两种视图切换
// 2. Article视图：展示所有博客文章列表，支持按标签筛选
// 3. Moment视图：展示朋友圈动态（类似微信朋友圈）
// 4. 左侧drawer sidebar包含博客更新热力图、视图切换和标签树
// ============================================

import "../styles/global.css";
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { buildTagTree } from "../utils/tags";
import DrawerToggle from "../components/ui/DrawerToggle.astro";
import BlogDrawerSidebar from "../components/blog/BlogDrawerSidebar.astro";
import MomentView from "../components/views/MomentView.astro";
import ArticleView from "../components/views/ArticleView.astro";

const pageTitle = "";

// 获取所有博客文章并按发布日期降序排序
const allPosts = await getCollection("blog");
const sortedPosts = [...allPosts].sort(
  (a, b) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
);

// 筛选出置顶文章
const pinnedPosts = sortedPosts.filter((post) => post.data.docked);

// 构建标签树结构（支持多级标签）
const tagTree = buildTagTree(sortedPosts);

// ============================================
// 生成博客更新热力图数据（GitHub风格）
// ============================================
// 显示过去364天（52周）的活动数据
const startDate = new Date();
startDate.setDate(startDate.getDate() - 364);

const formatDate = (date: Date) =>
  `${date.getFullYear()}-${`${date.getMonth() + 1}`.padStart(2, "0")}-${`${date.getDate()}`.padStart(2, "0")}`;

// 生成53周 x 7天的热力图数据
const heatmap = Array.from({ length: 53 }, (_, weekIndex) =>
  Array.from({ length: 7 }, (_, dayIndex) => {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + weekIndex * 7 + dayIndex);

    // 模拟活动强度（实际项目中应从数据库获取）
    const raw = (weekIndex * 3 + dayIndex * 5 + date.getDate()) % 10;
    const level = raw < 2 ? 0 : raw < 4 ? 1 : raw < 7 ? 2 : raw < 9 ? 3 : 4;

    return {
      date: formatDate(date),
      count: level * 2,
      level,
    };
  }),
);
---

<BaseLayout pageTitle={pageTitle}>
  <!-- Drawer侧边栏切换按钮 -->
  <DrawerToggle />

  <!-- Blog专用Drawer侧边栏（包含热力图和标签树） -->
  <BlogDrawerSidebar heatmap={heatmap} tagTree={tagTree} />

  <!-- 主内容区域 - 当drawer打开时会自动调整margin-left -->
  <div
    id="main-content"
    class="blog-page blog-page--index-theme"
    style="transition: margin-left 500ms cubic-bezier(0.4, 0, 0.2, 1);"
  >
    <!-- Article视图 - 默认显示 -->
    <ArticleView pinnedPosts={pinnedPosts} sortedPosts={sortedPosts} />

    <!-- Moment视图 - 朋友圈动态 -->
    <div id="moment-view" class="view-content hidden">
      <MomentView />
    </div>

    <!-- Toast提示框 - 用于显示复制链接等操作反馈 -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite">
      <div class="toast-surface">已复制链接</div>
    </div>

    <script is:inline>
      // ============================================
      // 视图切换功能
      // ============================================
      // 监听导航按钮点击，切换Article和Moment视图
      window.addEventListener("view-changed", (event) => {
        const { view } = event.detail;

        const articleView = document.getElementById("article-view");
        const momentView = document.getElementById("moment-view");

        if (view === "moment") {
          articleView?.classList.add("hidden");
          momentView?.classList.remove("hidden");
        } else if (view === "article") {
          momentView?.classList.add("hidden");
          articleView?.classList.remove("hidden");
        }
      });

      // ============================================
      // Drawer状态变化处理
      // ============================================
      // 监听drawer打开/关闭事件，自动调整主内容区域的左边距
      window.addEventListener("drawer-state-changed", (event) => {
        const { isOpen } = event.detail;
        const mainContent = document.getElementById("main-content");
        if (mainContent) {
          // drawer打开时，内容区向右推320px；关闭时恢复
          mainContent.style.marginLeft = isOpen ? "320px" : "0";
        }
      });
    </script>

    <style is:global>
      /* Hide scrollbar for the blog page */
      html:has(.blog-page),
      body:has(.blog-page) {
        scrollbar-width: none !important; /* Firefox */
        -ms-overflow-style: none !important; /* IE and Edge */
        overflow: -moz-scrollbars-none !important;
      }

      html:has(.blog-page)::-webkit-scrollbar,
      body:has(.blog-page)::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
        background: transparent !important;
      }

      /* Also ensure main-content containers hide scrollbars if they scroll individually */
      .blog-page,
      #main-content {
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
      }

      .blog-page::-webkit-scrollbar,
      #main-content::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
      }
    </style>
  </div>
</BaseLayout>
