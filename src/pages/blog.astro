---
import '../styles/global.css';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { buildTagTree, tagToSlug } from '../utils/tags';
import TagTreeNode from '../components/TagTreeNode.astro';
import GithubIcon from "../components/icon/GithubIcon.astro";

const pageTitle = '';
const allPosts = await getCollection('blog');
const sortedPosts = [...allPosts].sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);
const tagTree = buildTagTree(sortedPosts);

const expandTagPaths = (tag: string) => {
  const segments = tag
    .split('/')
    .map((segment) => segment.trim())
    .filter(Boolean);
  return segments.map((_, index) => segments.slice(0, index + 1).join('/'));
};

const getPostTagPaths = (tags: string[]) =>
  [...new Set(tags.flatMap((tag) => expandTagPaths(tag)))].join('|');

const startDate = new Date();
startDate.setDate(startDate.getDate() - 364);
const formatDate = (date: Date) =>
  `${date.getFullYear()}-${`${date.getMonth() + 1}`.padStart(2, '0')}-${`${date.getDate()}`.padStart(2, '0')}`;

const heatmap = Array.from({ length: 53 }, (_, weekIndex) =>
  Array.from({ length: 7 }, (_, dayIndex) => {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + weekIndex * 7 + dayIndex);
    const raw = (weekIndex * 3 + dayIndex * 5 + date.getDate()) % 10;
    const level = raw < 2 ? 0 : raw < 4 ? 1 : raw < 7 ? 2 : raw < 9 ? 3 : 4;
    return {
      date: formatDate(date),
      count: level * 2,
      level
    };
  })
);

const levelText = ['0 æ¬¡æäº¤', '1-2 æ¬¡æäº¤', '3-5 æ¬¡æäº¤', '6-8 æ¬¡æäº¤', '9+ æ¬¡æäº¤'];
---

<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
  </head>

  <body>
    <BaseLayout pageTitle={pageTitle}>
      <section class="space-y-4">
        <div class="rounded-3xl border border-base-300 bg-base-100 p-6 shadow-sm">
          <div class="mb-4 flex items-center justify-between gap-3">
            <div>
              <h1 class="text-2xl font-bold">Blog Timeline</h1>
              <p class="text-sm text-base-content/70">GitHub é£æ ¼è´¡çŒ®çƒ­åŠ›å›¾</p>
            </div>
            <a class="w-10 h-10" href="https://github.com/" target="_blank" rel="noreferrer">
              <GithubIcon/>
            </a>
          </div>

          <div class="overflow-x-auto pb-2">
            <div class="grid min-w-[860px] grid-flow-col gap-1">
              {heatmap.map((week) => (
                <div class="grid grid-rows-7 gap-1">
                  {week.map((day) => (
                    <div
                      class:list={[
                        'h-3 w-3 rounded-[3px] border border-black/5',
                        day.level === 0 && 'bg-base-300/70',
                        day.level === 1 && 'bg-emerald-200',
                        day.level === 2 && 'bg-emerald-400',
                        day.level === 3 && 'bg-emerald-600',
                        day.level === 4 && 'bg-emerald-800'
                      ]}
                      title={`${day.date} Â· ${day.count} commits`}
                      aria-label={`${day.date} ${levelText[day.level]}`}
                    ></div>
                  ))}
                </div>
              ))}
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-3 text-xs text-base-content/70">
            <span>Less</span>
            {levelText.map((text, level) => (
              <span class="inline-flex items-center gap-1">
                <span
                  class:list={[
                    'h-3 w-3 rounded-[3px] border border-black/5',
                    level === 0 && 'bg-base-300/70',
                    level === 1 && 'bg-emerald-200',
                    level === 2 && 'bg-emerald-400',
                    level === 3 && 'bg-emerald-600',
                    level === 4 && 'bg-emerald-800'
                  ]}
                ></span>{text}
              </span>
            ))}
            <span>More</span>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <div class="drawer lg:drawer-open blog-drawer" id="blog-drawer-layout">
          <input id="tag-drawer" type="checkbox" class="drawer-toggle" />
          <div class="drawer-content">
            <div class="mb-4 flex flex-wrap items-center justify-between gap-3">
              <div class="lg:hidden">
                <label for="tag-drawer" class="btn btn-outline btn-sm">æ‰“å¼€æ ‡ç­¾æŠ½å±‰</label>
              </div>
              <div id="active-tag-panel" class="hidden flex-1 rounded-2xl border border-primary/30 bg-primary/5 px-4 py-2 text-sm">
                å½“å‰ç­›é€‰ï¼š<span id="active-tag-name" class="font-semibold"></span>
                <button id="clear-tag-filter" type="button" class="btn btn-ghost btn-xs ml-2">æ¸…é™¤</button>
              </div>
            </div>
            <div id="post-list" class="space-y-4">
          {sortedPosts.map((post) => (
            <article
              class="rounded-3xl border border-base-300 bg-base-100 p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md"
              data-post-card
              data-tags={getPostTagPaths(post.data.tags)}
            >
              <div class="flex items-center gap-3 text-sm text-base-content/70">
                <div class="avatar placeholder">
                  <div class="w-9 rounded-full bg-neutral text-neutral-content">
                    <span>{post.data.author.slice(0, 1)}</span>
                  </div>
                </div>
                <div>
                  <p class="font-medium text-base-content">{post.data.author}</p>
                  <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </time>
                </div>
              </div>

              <h3 class="mt-3 text-xl font-semibold">
                <a class="link-hover" href={`/posts/${post.id}/`}>{post.data.title}</a>
              </h3>
              <p class="mt-2 text-sm leading-6 text-base-content/80">{post.data.description}</p>

              <div class="mt-3 flex flex-wrap gap-2">
                {post.data.tags.map((tag: string) => (
                  <button class="badge badge-outline tag-filter-btn" data-tag={tag} data-tag-slug={tagToSlug(tag)} type="button">#{tag}</button>
                ))}
              </div>

              // todo : ç‚¹èµã€è½¬å‘å’Œæ·»åŠ dockåŠŸèƒ½æœªå®Œæˆï¼›
              <div class="mt-4 flex items-center justify-end gap-2">
                <button class="btn btn-ghost btn-sm gap-1 text-base-content/80" type="button">â¤ï¸</button>
                <button class="btn btn-ghost btn-sm gap-1 text-base-content/80" type="button">ğŸ”</button>
                <button class="btn btn-primary btn-sm" type="button">â•</button>
              </div>
            </article>
          ))}
            </div>
            <p id="empty-filter-state" class="mt-6 hidden rounded-2xl border border-dashed border-base-300 bg-base-100 p-6 text-center text-base-content/70">æš‚æ— æ–‡ç« åŒ¹é…è¯¥æ ‡ç­¾ã€‚</p>
          </div>
          <div class="drawer-side z-20 blog-drawer-side">
            <label for="tag-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="min-h-full w-80 rounded-r-3xl border-r border-base-300 bg-base-100 p-5 shadow-sm lg:rounded-3xl lg:border lg:shadow-sm">
              <div class="mb-4 flex items-center justify-between">
                <h2 class="text-lg font-semibold">Tags</h2>
                <button id="toggle-sidebar" class="btn btn-ghost btn-xs hidden lg:inline-flex" type="button" aria-label="æ”¶èµ·æ ‡ç­¾ä¾§è¾¹æ ">â‡¥</button>
              </div>
              <ul id="tag-tree" class="space-y-2">
                {tagTree.map((tag) => <TagTreeNode node={tag} />)}
              </ul>
            </aside>
          </div>
        </div>
      </section>


      <script is:inline>
        const drawerLayout = document.getElementById('blog-drawer-layout');
        const sidebarToggle = document.getElementById('toggle-sidebar');
        const activeTagPanel = document.getElementById('active-tag-panel');
        const activeTagName = document.getElementById('active-tag-name');
        const clearFilterButton = document.getElementById('clear-tag-filter');
        const postCards = Array.from(document.querySelectorAll('[data-post-card]'));
        const emptyState = document.getElementById('empty-filter-state');

        const applyTagFilter = (tag) => {
          let visibleCount = 0;
          postCards.forEach((card) => {
            const tags = (card.getAttribute('data-tags') || '').split('|');
            const matched = !tag || tags.some((value) => value === tag || value.startsWith(`${tag}/`));
            card.classList.toggle('hidden', !matched);
            if (matched) visibleCount += 1;
          });

          if (activeTagPanel && activeTagName) {
            activeTagPanel.classList.toggle('hidden', !tag);
            activeTagName.textContent = tag ? `#${tag}` : '';
          }

          if (emptyState) {
            emptyState.classList.toggle('hidden', visibleCount > 0);
          }
        };

        document.querySelectorAll('.tag-filter-btn').forEach((button) => {
          button.addEventListener('click', () => {
            applyTagFilter(button.getAttribute('data-tag') || '');
          });
        });

        if (clearFilterButton) {
          clearFilterButton.addEventListener('click', () => applyTagFilter(''));
        }

        document.querySelectorAll('.tag-toggle').forEach((toggleButton) => {
          toggleButton.addEventListener('click', () => {
            const listItem = toggleButton.closest('li');
            const children = listItem?.querySelector(':scope > .tag-children');
            if (!children) return;

            const expanded = toggleButton.getAttribute('data-expanded') !== 'false';
            const nextExpanded = !expanded;
            toggleButton.setAttribute('data-expanded', `${nextExpanded}`);
            toggleButton.setAttribute('aria-expanded', `${nextExpanded}`);
            toggleButton.textContent = nextExpanded ? 'â–¾' : 'â–¸';
            children.classList.toggle('hidden', !nextExpanded);
          });
        });

        if (sidebarToggle && drawerLayout) {
          sidebarToggle.addEventListener('click', () => {
            const collapsed = drawerLayout.classList.toggle('blog-sidebar-collapsed');
            sidebarToggle.textContent = collapsed ? 'â‡¤' : 'â‡¥';
          });
        }
      </script>

      <style is:inline>
        @media (min-width: 1024px) {
          .blog-drawer .drawer-side > *:not(.drawer-overlay) {
            transition: width 0.2s ease;
          }

          .blog-sidebar-collapsed .blog-drawer-side aside {
            width: 3.5rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            overflow: hidden;
          }

          .blog-sidebar-collapsed .blog-drawer-side h2,
          .blog-sidebar-collapsed .blog-drawer-side #tag-tree {
            display: none;
          }
        }
      </style>

    </BaseLayout>
  </body>
</html>
